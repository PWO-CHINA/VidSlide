<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影幻智提 (VidSlide) v0.5.0 - 批量处理版</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/style.css?v=0.5.1">
    <script>
        // 在页面渲染前立即应用主题，避免闪烁
        (function(){
            const t = localStorage.getItem('vidslide_theme');
            if (t === 'dark' || (!t && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
</head>
<body class="min-h-screen pb-8">

    <!-- Toast 容器 -->
    <div id="toasts" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none" style="max-width:360px"></div>

    <!-- 错误详情弹窗 -->
    <div id="errorModal" class="error-modal-backdrop" onclick="if(event.target===this)closeErrorModal()">
        <div class="error-modal">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3"><span class="text-3xl">❌</span><h2 class="text-lg font-bold text-gray-900" id="errorModalTitle">出错了</h2></div>
                <button onclick="closeErrorModal()" class="text-gray-400 hover:text-gray-700 text-xl leading-none">&times;</button>
            </div>
            <div id="errorModalMessage" class="text-sm text-gray-700 mb-3 leading-relaxed"></div>
            <div id="errorModalHint" class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-800 mb-4 hidden">
                <p class="font-semibold mb-1">💡 建议操作：</p>
                <p id="errorModalHintText"></p>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <button onclick="closeErrorModal()" class="btn-secondary" style="min-width:80px">关闭</button>
                <a id="errorModalIssueLink" href="#" target="_blank" class="btn-primary flex items-center gap-2" style="text-decoration:none;font-size:13px">
                    🐛 提交 Issue 反馈
                </a>
            </div>
        </div>
    </div>

    <!-- ═══════ Header (Sticky) ═══════ -->
    <header class="sticky-header bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 text-white shadow-lg border-b border-slate-600/30 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-6 py-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-3 min-w-0">
                <img src="/static/logo.png" alt="VidSlide" class="logo-icon w-10 h-10 flex-shrink-0">
                <div class="min-w-0">
                    <h1 class="text-xl font-bold tracking-tight flex items-center gap-2 flex-wrap">
                        影幻智提 (VidSlide)
                        <span class="text-xs font-normal bg-white/15 px-2 py-0.5 rounded-full">v0.5.0</span>
                    </h1>
                    <p class="text-slate-400 dark:text-slate-400 text-xs mt-0.5 truncate">从录播视频中一键提取 PPT</p>
                </div>
            </div>
            <nav class="flex gap-2 items-center flex-shrink-0">
                <button onclick="toggleTheme()" class="theme-toggle" title="切换深色/浅色模式">
                    <span class="icon" id="themeIcon">🌙</span>
                </button>
                <button onclick="toggleBatchMode()" class="btn-ghost text-xs" id="btnToggleMode" title="切换批量处理模式">
                    📋 批量模式
                </button>
                <button onclick="cleanupAll()" class="btn-ghost text-xs" title="清空所有模式的全部缓存">
                    🗑️ 全部清空
                </button>
                <button onclick="shutdownServer()" class="btn-ghost-danger text-xs" title="关闭服务并清理临时文件">
                    ⏻ 关闭
                </button>
            </nav>
        </div>
        <!-- ═══════ 资源监控条（页眉内） ═══════ -->
        <div class="resource-bar" id="resourceBar">
            <div class="resource-item">
                <span class="res-label">CPU</span>
                <div class="res-bar-mini"><div id="resCpuBar" class="res-bar-mini-fill bg-blue-400" style="width:0%"></div></div>
                <span class="res-value" id="resCpuText">--%</span>
            </div>
            <div class="resource-item">
                <span class="res-label">内存</span>
                <div class="res-bar-mini"><div id="resMemBar" class="res-bar-mini-fill bg-emerald-400" style="width:0%"></div></div>
                <span class="res-value" id="resMemText">--%</span>
            </div>
            <div class="resource-item">
                <span class="res-label">磁盘剩余</span>
                <span class="res-value" id="resDiskText">-- GB</span>
            </div>
            <div class="resource-item" id="resGpuSection" style="display:none">
                <span class="res-label">GPU</span>
                <div class="res-bar-mini"><div id="resGpuBar" class="res-bar-mini-fill bg-purple-400" style="width:0%"></div></div>
                <span class="res-value" id="resGpuText">--%</span>
            </div>
            <div class="resource-item" style="border-left:1px solid rgba(255,255,255,.15);padding-left:12px">
                <span class="res-label">活跃任务</span>
                <span class="res-value" id="resTaskText">0</span>
            </div>
            <div class="resource-item">
                <span class="res-label">标签页</span>
                <span class="res-value" id="resTabText">0/3</span>
            </div>
        </div>
    </header>
    <div class="resource-warning-banner" id="resourceWarning"></div>

    <!-- ═══════ 主区域 ═══════ -->
    <main class="max-w-7xl mx-auto px-6 py-6">

        <!-- 标签栏 -->
        <div class="tab-bar" id="tabBar">
            <!-- 标签会动态插入 -->
            <div class="tab-add" id="tabAddBtn" onclick="addNewTab()" title="新建标签页 (最多3个)">＋</div>
        </div>

        <!-- 标签页内容区 -->
        <div class="tab-content-area" id="tabContentArea">
            <!-- 每个标签页的内容面板会动态插入 -->
            <div id="emptyHint" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <span class="text-5xl mb-4">📂</span>
                <p class="text-lg font-medium mb-2">点击上方 ＋ 新建一个标签页开始工作</p>
                <p class="text-sm">每个标签页可独立处理一个视频，最多同时开 3 个</p>
            </div>
        </div>
    </main>

    <!-- ═══════ 批量处理面板（默认隐藏） ═══════ -->
    <div id="batchPanel" class="batch-panel max-w-5xl mx-auto px-6 py-6" style="display:none">

        <!-- 磁盘空间预警 -->
        <div id="batchDiskWarning" class="batch-disk-warning" style="display:none">
            ⚠️ 磁盘空间不足（剩余 <span id="batchDiskFree">0</span> MB），部分视频可能被跳过
        </div>

        <!-- 全局参数卡片 -->
        <section class="card mb-4">
            <h3 class="text-sm font-semibold mb-3 flex items-center gap-2">
                <span class="w-6 h-6 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-xs font-bold">1</span>
                全局提取参数
                <span class="text-xs text-slate-400 font-normal">（所有视频共用）</span>
            </h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-slate-300 mb-1">
                        场景检测灵敏度: <span id="batchThresholdVal" class="font-bold text-brand-600">5.0</span>
                    </label>
                    <input type="range" id="batchThreshold" min="1" max="15" step="0.5" value="5"
                           class="w-full accent-brand-500">
                    <div class="flex justify-between text-xs text-slate-400 mt-0.5">
                        <span>敏感 (1)</span><span>保守 (15)</span>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <div>
                        <label class="flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300 cursor-pointer">
                            <input type="checkbox" id="batchUseRoi" checked> PPT 录屏裁剪
                        </label>
                        <p class="text-xs text-slate-400 mt-0.5 ml-5">启用后忽略左侧缩略图栏和顶部工具栏</p>
                    </div>
                    <div>
                        <label class="flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300 cursor-pointer">
                            <input type="checkbox" id="batchFastMode" checked> ⚡ 快速模式
                        </label>
                        <p class="text-xs text-slate-400 mt-0.5 ml-5">将比较分辨率降至 480p 以加速检测（不影响输出质量）</p>
                    </div>
                    <div>
                        <label class="flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300 cursor-pointer">
                            <input type="checkbox" id="batchUseGpu" checked> 🎮 GPU 硬件加速
                        </label>
                        <p class="text-xs text-slate-400 mt-0.5 ml-5">使用显卡加速视频解码（不支持时自动回退 CPU）</p>
                    </div>
                </div>
                <div class="flex flex-col gap-3">
                    <div>
                        <label class="flex items-center gap-2 text-xs font-medium text-slate-600 dark:text-slate-300 cursor-pointer">
                            <input type="checkbox" id="batchEnableHistory" checked> 历史记忆池
                            <input type="number" id="batchMaxHistory" value="5" min="2" max="20"
                                   class="w-14 text-xs px-1 py-0.5 border rounded dark:bg-slate-700 dark:border-slate-600"> 张
                        </label>
                        <p class="text-xs text-slate-400 mt-0.5 ml-5">防止 A→B→A 跳页导致重复提取</p>
                    </div>
                    <div>
                        <label class="text-xs font-medium text-slate-600 dark:text-slate-300 block mb-1">🎯 运行模式</label>
                        <select id="batchSpeedMode" class="w-full text-xs px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600">
                            <option value="eco">🍃 后台静默 (Eco)</option>
                            <option value="fast" selected>🚀 全速狂飙 (Fast) — 推荐</option>
                            <option value="turbo">⚡ 极速狂暴 (Turbo)</option>
                        </select>
                        <p class="text-xs text-slate-400 mt-0.5">Eco 节省资源；Fast 释放算力；Turbo 极限压榜</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 队列列表 -->
        <section class="card mb-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-xs font-bold">2</span>
                    视频队列
                    <span class="text-xs text-slate-400 font-normal" id="batchQueueCount">（0 个视频）</span>
                </h3>
                <div class="flex gap-2">
                    <button onclick="clearBatchQueue()" class="btn-ghost-danger text-xs" id="btnBatchClearQueue" style="display:none">
                        清空队列
                    </button>
                </div>
            </div>

            <!-- 空状态 -->
            <div id="batchEmptyHint" class="text-center py-12 text-slate-400">
                <span class="text-4xl mb-3 block">📁</span>
                <p class="text-sm mb-2">队列为空，请添加视频</p>
                <p class="text-xs">支持多选文件或选择整个文件夹</p>
            </div>

            <!-- 队列列表容器 -->
            <div id="batchQueueList" class="batch-queue-list" style="display:none"></div>
        </section>

        <!-- 底部控制栏 -->
        <div class="batch-control-bar card">
            <div class="flex items-center justify-between flex-wrap gap-3">
                <div class="flex items-center gap-2">
                    <button onclick="addVideosToBatch()" class="btn-secondary text-xs" id="btnBatchAddFiles">
                        📂 添加视频
                    </button>
                    <button onclick="scanFolderForBatch()" class="btn-secondary text-xs" id="btnBatchScanFolder"
                            title="递归扫描文件夹中所有视频文件（mp4/avi/mkv/mov 等）">
                        📁 扫描文件夹
                    </button>
                    <button onclick="openBatchVideoRecycleBin()" class="btn-ghost text-xs" id="btnBatchVideoRecycle"
                            title="查看回收站中的视频">
                        🗑️ 回收站
                    </button>
                    <button onclick="cleanupBatchMode()" class="btn-ghost-danger text-xs" id="btnBatchCleanup"
                            title="清空批量队列的所有数据">
                        🧹 清空批量
                    </button>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-1">
                        <label class="text-xs text-slate-500 dark:text-slate-400">并发数:</label>
                        <select id="batchWorkerCount" class="text-xs px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600">
                            <option value="1" selected>1（低占用）</option>
                            <option value="2">2（均衡）</option>
                            <option value="3">3（高性能）</option>
                        </select>
                    </div>
                    <button onclick="startBatch()" class="btn-primary text-xs" id="btnBatchStart" disabled>
                        ▶ 开始处理
                    </button>
                    <button onclick="pauseBatch()" class="btn-secondary text-xs" id="btnBatchPause" style="display:none">
                        ⏸ 暂停
                    </button>
                    <button onclick="resumeBatch()" class="btn-primary text-xs" id="btnBatchResume" style="display:none">
                        ▶ 继续
                    </button>
                    <button onclick="cancelBatch()" class="bg-red-500 hover:bg-red-600 text-white text-xs font-medium px-3 py-1.5 rounded-lg transition shadow-sm" id="btnBatchCancel" style="display:none">
                        ✕ 取消全部
                    </button>
                </div>
            </div>

            <!-- 全局进度条（紧贴控制栏下方） -->
            <div class="batch-global-stats mt-3" id="batchGlobalStats" style="display:none">
                <div class="flex items-center justify-between mb-1.5">
                    <span class="text-xs font-medium text-slate-700 dark:text-slate-200" id="batchStatsText">就绪</span>
                    <span class="text-xs text-slate-500 dark:text-slate-400" id="batchStatsDetail"></span>
                </div>
                <div class="progress-track">
                    <div class="progress-fill" id="batchGlobalProgress" style="width:0%"></div>
                </div>
                <div class="flex items-center justify-between mt-1">
                    <span class="text-xs text-slate-400" id="batchProgressPct"></span>
                    <span class="text-xs text-slate-400" id="batchProgressEta"></span>
                </div>
            </div>
        </div>

        <!-- 批量导出区域 -->
        <div id="batchExportSection" class="card mt-4" style="display:none">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold flex items-center gap-2">
                    <span class="w-6 h-6 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-xs font-bold">3</span>
                    批量导出
                </h3>
                <div class="flex items-center gap-2">
                    <button id="batchSelectToggleBtn" onclick="selectAllBatchVideos()" class="btn-ghost text-xs">取消全选</button>
                    <span class="text-xs text-slate-400" id="batchExportHint">已选择 0 个视频</span>
                </div>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <button onclick="packageBatchAll('zip')" class="btn-export text-xs" id="btnBatchExportZip">
                    导出选中 ZIP
                </button>
                <button onclick="packageBatchAll('pdf')" class="btn-export text-xs" id="btnBatchExportPdf">
                    导出选中 PDF
                </button>
                <button onclick="packageBatchAll('pptx')" class="btn-export text-xs" id="btnBatchExportPptx">
                    导出选中 PPTX
                </button>
            </div>
            <div class="mt-2" id="batchExportProgress" style="display:none">
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="batchExportProgressBar" style="width:0%"></div>
                </div>
                <p class="text-xs text-slate-500 mt-1" id="batchExportMessage"></p>
            </div>
            <div id="batchDownloadSection" class="mt-2"></div>
        </div>

        <!-- 完成横幅 -->
        <div id="batchCompleteBanner" class="batch-complete-banner" style="display:none">
            <div class="flex items-center justify-between">
                <div>
                    <span class="text-lg mr-2">✅</span>
                    <span class="font-medium" id="batchCompleteText">批量处理完成</span>
                </div>
                <button onclick="document.getElementById('batchCompleteBanner').style.display='none'"
                        class="btn-ghost text-xs">关闭</button>
            </div>
        </div>
    </div>

    <!-- ═══════ 批量添加视频命名弹窗 ═══════ -->
    <div id="batchAddModal" class="modal-overlay" style="display:none" onclick="if(event.target===this)cancelBatchAdd()">
        <div class="modal-content batch-add-modal">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold">📝 视频命名</h3>
                <button onclick="cancelBatchAdd()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 text-lg leading-none" title="关闭 (ESC)">&times;</button>
            </div>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">
                为每个视频设置显示名称，用于导出时的文件夹命名
            </p>

            <!-- 命名方式选择 -->
            <div class="flex items-center gap-4 mb-3 p-2 bg-slate-50 dark:bg-slate-800 rounded">
                <label class="flex items-center gap-1.5 text-xs cursor-pointer">
                    <input type="radio" name="batchNamingMode" value="original" checked onchange="_onNamingModeChange()"> 保留原文件名
                </label>
                <label class="flex items-center gap-1.5 text-xs cursor-pointer">
                    <input type="radio" name="batchNamingMode" value="template" onchange="_onNamingModeChange()"> 使用命名模板
                </label>
                <label class="flex items-center gap-1.5 text-xs cursor-pointer">
                    <input type="radio" name="batchNamingMode" value="free" onchange="_onNamingModeChange()"> 自由编辑
                </label>
            </div>

            <!-- 模板区域 -->
            <div id="namingTemplateArea" style="display:none" class="mb-3 p-3 bg-slate-50 dark:bg-slate-800 rounded space-y-2">
                <div class="flex items-center gap-2">
                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300 whitespace-nowrap">课程/主题：</label>
                    <input type="text" id="batchCourseName" placeholder="如：高等数学"
                           class="flex-1 text-xs px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600">
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300 whitespace-nowrap">命名模板：</label>
                    <select id="batchNamingTemplate" class="flex-1 text-xs px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600">
                        <option value="course_lessonN">课程名_第N节（如：高等数学_第1节）</option>
                        <option value="lessonN_course">第N讲_课程名（如：第1讲_高等数学）</option>
                        <option value="course_parenN">课程名(N)（如：高等数学(1)）</option>
                        <option value="course_dashN">课程名-N（如：高等数学-01）</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-medium text-slate-600 dark:text-slate-300 whitespace-nowrap">起始编号：</label>
                    <input type="number" id="batchStartNum" value="1" min="1"
                           class="w-16 text-xs px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600">
                    <button onclick="previewTemplateNames()" class="btn-ghost text-xs">预览命名</button>
                    <button onclick="applyTemplateNames()" class="btn-primary text-xs">应用</button>
                </div>
            </div>

            <!-- 自由编辑区域（旧版自动递增） -->
            <div id="batchAutoIncrementArea" style="display:none" class="mb-3">
                <div class="flex items-center gap-2 p-2 bg-slate-50 dark:bg-slate-800 rounded">
                    <label class="flex items-center gap-2 text-xs">
                        <input type="checkbox" id="batchAutoIncrement"> 自动递增命名
                    </label>
                    <input type="text" id="batchBaseNameInput" placeholder="如: 数学_第1节"
                           class="flex-1 text-xs px-2 py-1 border rounded dark:bg-slate-700 dark:border-slate-600"
                           disabled>
                    <button onclick="previewAutoIncrement()" class="btn-ghost text-xs" id="btnPreviewIncrement" disabled>
                        预览
                    </button>
                </div>
            </div>

            <!-- 排序按钮 -->
            <div class="flex items-center gap-2 mb-2">
                <span class="text-xs text-slate-500">排序：</span>
                <button onclick="sortBatchAddList('asc')" class="btn-ghost text-xs" title="按名称升序">名称 ↑</button>
                <button onclick="sortBatchAddList('desc')" class="btn-ghost text-xs" title="按名称降序">名称 ↓</button>
            </div>

            <!-- 文件列表 -->
            <div id="batchAddList" class="batch-add-list max-h-64 overflow-y-auto mb-3"></div>

            <div class="flex justify-end gap-2">
                <button onclick="cancelBatchAdd()" class="btn-ghost text-xs">取消</button>
                <button onclick="confirmBatchAdd()" class="btn-primary text-xs">确认添加</button>
            </div>
        </div>
    </div>

    <!-- ═══════ 底部 ═══════ -->
    <footer class="max-w-5xl mx-auto px-4 pb-8 mt-12">
        <div class="border-t border-slate-200 dark:border-slate-700 pt-8">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-4">
                <div class="flex items-center gap-3">
                    <img src="/static/logo.png" alt="VidSlide" class="logo-icon w-8 h-8">
                    <div class="text-left">
                        <p class="text-sm font-semibold text-slate-700 dark:text-slate-300">影幻智提 (VidSlide)</p>
                        <p class="text-xs text-slate-500 dark:text-slate-500">开源 PPT 提取工具</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <a href="https://github.com/PWO-CHINA/VidSlide" target="_blank" rel="noopener" class="footer-link" title="在 GitHub 上给我们 Star ⭐">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                        <span>GitHub</span>
                    </a>
                    <a href="https://gitee.com/pwo101/VidSlide" target="_blank" rel="noopener" class="footer-link" title="在 Gitee 上给我们 Star ⭐">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M11.984 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.016 0zm6.09 5.333c.328 0 .593.266.592.593v1.482a.594.594 0 0 1-.593.592H9.777c-.982 0-1.778.796-1.778 1.778v5.63c0 .327.266.592.593.592h5.63c.982 0 1.778-.796 1.778-1.778v-.296a.593.593 0 0 0-.592-.593h-4.037a.594.594 0 0 1-.592-.593v-1.482a.593.593 0 0 1 .593-.592h6.815c.327 0 .593.265.593.592v3.408a4 4 0 0 1-4 4H5.926a.593.593 0 0 1-.593-.593V9.778a4.444 4.444 0 0 1 4.445-4.444h8.296Z"/></svg>
                        <span>Gitee</span>
                    </a>
                </div>
            </div>
            <div class="text-center space-y-1">
                <p class="text-xs text-slate-500 dark:text-slate-500">🔒 所有数据仅保存在本地 · 浏览器断联 5 分钟后服务自动退出</p>
                <p class="text-xs text-slate-400 dark:text-slate-600">v0.5.0 批量处理版 · Made with ❤️ by <a href="https://github.com/PWO-CHINA" target="_blank" class="hover:text-slate-600 dark:hover:text-slate-400 transition">PWO-CHINA</a></p>
                <p class="text-xs text-slate-400 dark:text-slate-600 mt-2">⭐ 如果这个工具帮到了你，请在 <a href="https://github.com/PWO-CHINA/VidSlide" target="_blank" class="text-slate-600 dark:text-slate-400 hover:underline font-medium">GitHub</a> 或 <a href="https://gitee.com/pwo101/VidSlide" target="_blank" class="text-slate-600 dark:text-slate-400 hover:underline font-medium">Gitee</a> 上给我们一个 Star！</p>
            </div>
        </div>
    </footer>

    <!-- ═══════ 回收站抽屉 ═══════ -->
    <div id="recycleBackdrop" class="recycle-backdrop" onclick="closeRecycleBin()"></div>
    <div id="recycleDrawer" class="recycle-drawer">
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                🗑️ 回收站 <span id="recycleDrawerCount" class="text-sm font-normal text-gray-400"></span>
            </h3>
            <div class="flex gap-2">
                <button onclick="restoreAll()" id="btnRestoreAll" class="btn-secondary" style="font-size:.75rem;padding:.375rem .75rem;color:#4f46e5;border-color:#c7d2fe;background:#eef2ff">
                    ↩️ 全部恢复
                </button>
                <button onclick="closeRecycleBin()" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 flex items-center justify-center transition">✕</button>
            </div>
        </div>
        <div id="recycleList" class="flex-1 overflow-y-auto p-4 space-y-2">
            <p id="recycleEmpty" class="text-center text-gray-400 text-sm py-12">回收站是空的</p>
        </div>
    </div>

    <!-- ═══════ 批量视频回收站抽屉 ═══════ -->
    <div id="batchVideoRecycleBackdrop" class="recycle-backdrop" onclick="closeBatchVideoRecycleBin()"></div>
    <div id="batchVideoRecycleDrawer" class="recycle-drawer">
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100 dark:border-slate-700">
            <h3 class="text-lg font-bold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                🗑️ 视频回收站 <span id="batchVideoRecycleCount" class="text-sm font-normal text-gray-400"></span>
            </h3>
            <div class="flex gap-2">
                <button onclick="restoreAllBatchVideos()" id="btnBatchVideoRestoreAll" class="btn-secondary" style="font-size:.75rem;padding:.375rem .75rem;color:#4f46e5;border-color:#c7d2fe;background:#eef2ff">
                    ↩️ 全部恢复
                </button>
                <button onclick="closeBatchVideoRecycleBin()" class="w-8 h-8 rounded-lg hover:bg-gray-100 dark:hover:bg-slate-700 text-gray-400 hover:text-gray-600 flex items-center justify-center transition">✕</button>
            </div>
        </div>
        <div id="batchVideoRecycleList" class="flex-1 overflow-y-auto p-4 space-y-2">
            <p class="text-center text-gray-400 text-sm py-12">回收站是空的</p>
        </div>
    </div>

    <!-- ═══════ 图片预览弹窗 ═══════ -->
    <div id="previewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop" onclick="if(event.target===this)hidePreview()">
        <button onclick="hidePreview()" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-white/10 hover:bg-white/25 text-white text-xl flex items-center justify-center transition">✕</button>
        <button onclick="deleteInPreview()" id="btnDeletePreview" class="preview-del-btn absolute bottom-6 right-5 z-[60] px-4 py-2 rounded-full bg-red-500/70 hover:bg-red-600/90 text-white text-sm font-medium flex items-center gap-1.5 transition-all shadow-lg backdrop-blur" title="删除当前图片 (Delete)">🗑️ 删除 (Del)</button>
        <button onclick="prevPreview()" id="btnPrevPreview" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/25 text-white text-2xl flex items-center justify-center transition">◀</button>
        <button onclick="nextPreview()" id="btnNextPreview" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/25 text-white text-2xl flex items-center justify-center transition">▶</button>
        <img id="previewImage" class="max-w-[90vw] max-h-[85vh] rounded-lg shadow-2xl object-contain select-none" draggable="false">
        <div id="previewCounter" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-4 py-1.5 rounded-full backdrop-blur"></div>
    </div>

    <!-- ═══════ 标签页内容模板（hidden，JS 克隆使用）═══════ -->
    <template id="tabPaneTemplate">
        <div class="tab-pane p-6 space-y-6">
            <!-- 步骤 1: 选择视频 -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-sm font-bold">1</span>
                    选择视频文件
                </h2>
                <div class="flex flex-col sm:flex-row gap-3 items-stretch">
                    <button class="btn-primary shrink-0 js-btn-select-video">📁 浏览选择视频文件</button>
                    <div class="relative flex-1">
                        <input type="text" class="js-video-path-input w-full h-full px-4 py-3 text-sm rounded-2xl border-2 border-gray-200 focus:border-brand-400 focus:ring-4 focus:ring-brand-100 outline-none transition bg-gray-50 placeholder-gray-400" placeholder='粘贴路径，支持引号包裹，如 "D:\video\lecture.mp4"'>
                        <button class="js-btn-confirm-path absolute right-2 top-1/2 -translate-y-1/2 text-xs text-white bg-slate-600 hover:bg-slate-700 font-medium px-3 py-1.5 rounded-lg transition shadow-sm">确认 ↵</button>
                    </div>
                </div>
                <div class="js-video-info hidden mt-3 px-4 py-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                    <p class="text-sm text-emerald-800 flex items-center gap-2">
                        <span class="text-lg">✅</span>
                        <span class="js-video-path-display font-mono text-xs break-all"></span>
                    </p>
                </div>
            </section>

            <!-- 步骤 2: 参数设置 -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-sm font-bold">2</span>
                    提取参数
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">场景检测灵敏度</label>
                        <input type="range" min="1" max="15" step="0.5" value="5" class="range-input js-threshold">
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>敏感 (1)</span>
                            <span class="text-sm font-bold text-brand-600 js-threshold-val">5</span>
                            <span>保守 (15)</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-use-roi">
                            PPT 录屏裁剪
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed">启用后忽略左侧缩略图栏和顶部工具栏</p>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-enable-history">
                            历史记忆池
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed">防止 A→B→A 跳页导致重复提取</p>
                        <div class="js-max-history-group items-center gap-2 text-sm text-gray-600" style="display:flex">
                            <span>容量:</span>
                            <input type="number" value="5" min="2" max="20" class="w-16 px-2 py-1 text-sm rounded-lg border border-gray-200 text-center js-max-history">
                            <span class="text-xs text-gray-400">张</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                        <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-fast-mode">
                        ⚡ 快速模式
                    </label>
                    <p class="text-xs text-gray-400 leading-relaxed mt-1">将比较分辨率降至 480p 以加速检测（不影响输出图片质量）</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100 flex flex-col sm:flex-row sm:items-start gap-6">
                    <div class="flex-1">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-use-gpu">
                            🎮 GPU 硬件加速
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed mt-1">使用显卡加速视频解码（不支持时自动回退 CPU）。如遇花屏/崩溃可关闭此选项</p>
                    </div>
                    <div class="flex-1">
                        <label class="text-sm font-medium text-gray-700 block mb-1">🎯 运行模式</label>
                        <select class="js-speed-mode w-full px-3 py-2 text-sm rounded-xl border-2 border-gray-200 focus:border-brand-400 focus:ring-4 focus:ring-brand-100 outline-none transition bg-white">
                            <option value="eco">🍃 后台静默 (Eco)</option>
                            <option value="fast" selected>🚀 全速狂飙 (Fast)</option>
                            <option value="turbo">⚡ 极速狂暴 (Turbo)</option>
                        </select>
                        <p class="text-xs text-gray-400 leading-relaxed mt-1">Eco 节省资源；Fast 释放算力；Turbo 极限压榜（2x跳帧+320p对比）</p>
                    </div>
                </div>
                <details class=”mt-3 px-3 py-2 bg-amber-50 border border-amber-200 rounded-xl”>
                    <summary class=”text-xs text-amber-700 cursor-pointer select-none”>💡 核显用户性能提示（点击展开）</summary>
                    <p class=”text-xs text-amber-700 leading-relaxed mt-1.5”>选择 <em>Turbo/Fast</em> + <em>关闭 GPU 加速</em>，让 CPU 负责解码速度更快。核显的 GPU 加速主要优势是”减负”而非”加速”，适合 Eco 模式后台挂机。</p>
                </details>
                <!-- 重置按钮由 JS 动态插入 -->
            </section>

            <!-- 步骤 3: 提取 -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-sm font-bold">3</span>
                    提取幻灯片
                </h2>
                <div class="flex items-center gap-3">
                    <button class="btn-primary js-btn-extract" disabled>▶️ 开始提取幻灯片</button>
                    <button class="btn-resume hidden js-btn-resume">🔄 继续提取（断点续传）</button>
                    <button class="btn-danger hidden js-btn-cancel">⏹️ 取消提取</button>
                    <span class="text-sm text-gray-500 js-extract-status"></span>
                </div>
                <div class="js-progress-section hidden mt-5 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 font-medium js-progress-message">正在初始化…</span>
                        <span class="font-bold text-slate-700 dark:text-slate-200 text-lg tabular-nums js-progress-pct">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill js-progress-bar" style="width:0%"></div>
                    </div>
                    <p class="text-xs text-gray-400 js-progress-hint">提取中，请勿关闭此页面…</p>
                </div>
            </section>

            <!-- 步骤 4: 画廊管理 -->
            <section class="card hidden js-gallery-section">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-sm font-bold">4</span>
                        图片管理
                        <span class="text-sm font-normal text-gray-400 ml-2 js-image-count"></span>
                    </h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button class="btn-secondary text-sm hidden js-btn-recycle-bin">
                            🗑️ 回收站 <span class="bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 ml-1 js-recycle-count"></span>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-4 flex items-center gap-4">
                    <span>🖱️ 拖拽调整顺序</span>
                    <span>🔍 点击预览大图</span>
                    <span>❌ 悬停显示删除</span>
                    <span>⌨️ Ctrl+Z 撤销删除</span>
                </p>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 js-gallery"></div>
            </section>

            <!-- 步骤 5: 打包导出 -->
            <section class="card hidden js-export-section">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 flex items-center justify-center text-sm font-bold">5</span>
                    打包导出
                </h2>
                <p class="text-sm text-gray-500 mb-5">将当前排好序的图片打包下载</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button class="btn-export js-btn-pdf">
                        <span class="text-3xl">📄</span>
                        <span class="text-base font-bold">生成 PDF</span>
                        <span class="text-xs text-gray-400 font-normal">适合打印和阅读</span>
                    </button>
                    <button class="btn-export js-btn-pptx">
                        <span class="text-3xl">📊</span>
                        <span class="text-base font-bold">生成 PPTX</span>
                        <span class="text-xs text-gray-400 font-normal">可编辑的演示文稿</span>
                    </button>
                    <button class="btn-export js-btn-zip">
                        <span class="text-3xl">📦</span>
                        <span class="text-base font-bold">打包 ZIP</span>
                        <span class="text-xs text-gray-400 font-normal">原图打包压缩</span>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-3">💡 导出的文件会保存到浏览器的默认<b>下载文件夹</b>中</p>

                <!-- 打包进度条（SSE 驱动，异步打包时显示） -->
                <div class="hidden mt-5 space-y-2 js-pkg-progress-section">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 font-medium flex items-center gap-2">
                            <span class="pkg-spinner"></span>
                            <span class="js-pkg-progress-message">正在打包…</span>
                        </span>
                        <span class="font-bold text-slate-700 dark:text-slate-200 text-sm tabular-nums js-pkg-progress-pct">0%</span>
                    </div>
                    <div class="progress-track" style="height:10px">
                        <div class="progress-fill js-pkg-progress-bar" style="width:0%;height:100%"></div>
                    </div>
                </div>

                <div class="hidden mt-5 space-y-2 js-download-section"></div>
            </section>
        </div>
    </template>

    <!-- ═══════ 批量视频详情弹窗 ═══════ -->
    <div id="batchDetailModal" class="fixed inset-0 z-50 hidden" onclick="if(event.target===this)closeBatchDetail()">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative z-10 max-w-5xl mx-auto mt-8 mb-8 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden flex flex-col" style="max-height:calc(100vh - 4rem)">
            <!-- 头部 -->
            <div class="flex items-center justify-between px-6 py-4 border-b border-slate-200 dark:border-slate-700">
                <div class="flex items-center gap-3 min-w-0">
                    <span class="text-lg">🎬</span>
                    <h3 class="text-sm font-semibold truncate" id="batchDetailTitle">视频详情</h3>
                    <span class="text-xs text-slate-400" id="batchDetailCount"></span>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button onclick="_batchDetailExport('zip')" class="btn-ghost text-xs" title="导出 ZIP">导出 ZIP</button>
                    <button onclick="_batchDetailExport('pdf')" class="btn-ghost text-xs" title="导出 PDF">导出 PDF</button>
                    <button onclick="_batchDetailExport('pptx')" class="btn-ghost text-xs" title="导出 PPTX">导出 PPTX</button>
                    <button id="batchDetailRecycleBtn" onclick="_openBatchDetailRecycleBin()" class="btn-ghost text-xs" style="display:none" title="查看已删除图片">🗑 回收站</button>
                    <button onclick="closeBatchDetail()" class="w-8 h-8 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400 hover:text-slate-600 flex items-center justify-center transition">✕</button>
                </div>
            </div>
            <!-- 画廊 -->
            <div class="flex-1 overflow-y-auto p-6" id="batchDetailGallery">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" id="batchDetailGrid"></div>
                <!-- 图片回收站面板（内嵌） -->
                <div id="batchDetailRecyclePanel" class="mt-4 p-4 bg-slate-50 dark:bg-slate-900 rounded-xl border border-slate-200 dark:border-slate-700" style="display:none">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-xs font-semibold text-slate-600 dark:text-slate-300">🗑 已删除的图片</h4>
                        <button onclick="_closeBatchDetailRecycleBin()" class="text-xs text-slate-400 hover:text-slate-600">收起</button>
                    </div>
                    <div id="batchDetailRecycleList" class="space-y-2 max-h-48 overflow-y-auto"></div>
                </div>
            </div>
            <!-- 底部信息 -->
            <div class="px-6 py-3 border-t border-slate-200 dark:border-slate-700 flex items-center justify-between text-xs text-slate-400">
                <span id="batchDetailInfo">点击图片放大预览 · Delete 删除 · Ctrl+Z 撤销 · 拖拽排序</span>
                <span id="batchDetailExportStatus"></span>
            </div>
        </div>
    </div>

    <script src="/static/js/main.js?v=0.5.1"></script>
    <script src="/static/js/batch.js?v=0.5.1"></script>
</body>
</html>
