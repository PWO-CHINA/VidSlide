<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½±å¹»æ™ºæ (VidSlide) v0.2.1 - å¤šä»»åŠ¡ç‰ˆ</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' }
                    }
                }
            }
        }
    </script>
    <style>
        /* â”€â”€â”€ å…¨å±€ â”€â”€â”€ */
        body { font-family: 'Segoe UI', 'Microsoft YaHei', system-ui, -apple-system, sans-serif; }
        .card { @apply bg-white rounded-2xl shadow-md border border-gray-100 p-6 transition-shadow hover:shadow-lg; }

        /* â”€â”€â”€ è¿›åº¦æ¡ â”€â”€â”€ */
        .progress-track { @apply w-full h-5 bg-gray-200 rounded-full overflow-hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,.06); }
        .progress-fill  {
            height: 100%; border-radius: 9999px;
            background: linear-gradient(90deg, #4f46e5 0%, #818cf8 50%, #6366f1 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
            transition: width .4s cubic-bezier(.4,0,.2,1);
            box-shadow: 0 0 14px rgba(99,102,241,.45);
            position: relative;
        }
        .progress-fill::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,.35) 50%, transparent 100%);
            animation: progressGlow 1.8s ease-in-out infinite;
        }
        @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        @keyframes progressGlow { 0%,100%{opacity:0;transform:translateX(-100%)} 50%{opacity:1;transform:translateX(100%)} }

        /* â”€â”€â”€ Gallery å¡ç‰‡ â”€â”€â”€ */
        .slide-card {
            @apply relative rounded-xl overflow-hidden bg-gray-100 border-2 border-transparent cursor-grab;
            transition: transform .2s, box-shadow .2s, border-color .2s;
            aspect-ratio: 16/9;
        }
        .slide-card:hover { transform: translateY(-4px); box-shadow: 0 12px 28px rgba(0,0,0,.12); border-color: #818cf8; }
        .slide-card img  { @apply w-full h-full object-cover; pointer-events: none; }
        .slide-card .overlay {
            @apply absolute inset-0 flex items-start justify-between p-2;
            opacity: 0; transition: opacity .2s;
            background: linear-gradient(180deg, rgba(0,0,0,.45) 0%, transparent 50%, transparent 80%, rgba(0,0,0,.35) 100%);
        }
        .slide-card:hover .overlay { opacity: 1; }

        /* â”€â”€â”€ Sortable â”€â”€â”€ */
        .sortable-ghost  { opacity:.35; border: 2px dashed #818cf8; }
        .sortable-chosen { box-shadow: 0 0 0 3px #4f46e5; }
        .sortable-drag   { opacity:.9; transform: rotate(2deg) scale(1.05); }

        /* â”€â”€â”€ é¢„è§ˆå¼¹çª— â”€â”€â”€ */
        .modal-backdrop {
            background: rgba(0,0,0,.88); backdrop-filter: blur(12px);
            transition: opacity .25s;
        }

        /* â”€â”€â”€ Toast â”€â”€â”€ */
        .toast-enter  { animation: slideInRight .35s ease forwards; }
        .toast-leave  { animation: slideOutRight .3s ease forwards; }
        @keyframes slideInRight  { from{transform:translateX(120%);opacity:0} to{transform:translateX(0);opacity:1} }
        @keyframes slideOutRight { from{transform:translateX(0);opacity:1} to{transform:translateX(120%);opacity:0} }

        /* â”€â”€â”€ æŒ‰é’®ç³»ç»Ÿ â”€â”€â”€ */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 0.625rem;
            font-weight: 500; font-size: 0.875rem; line-height: 1.5;
            transition: all 0.15s ease;
            user-select: none; cursor: pointer; white-space: nowrap;
            border: 1.5px solid transparent; background: none;
            font-family: inherit;
        }
        .btn:active:not(:disabled) { transform: scale(0.97); }
        .btn:disabled { opacity: 0.45; cursor: not-allowed; pointer-events: none; }

        .btn-primary {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.625rem 1.5rem; border-radius: 0.75rem;
            font-weight: 600; font-size: 0.9375rem; line-height: 1.5;
            color: #fff; background: #6366f1; border: 1.5px solid #5b5df0;
            box-shadow: 0 1px 3px rgba(99,102,241,.2);
            transition: all 0.2s ease; cursor: pointer; user-select: none;
            white-space: nowrap; font-family: inherit;
        }
        .btn-primary:hover:not(:disabled) {
            background: #5558e8; border-color: #4f52dc;
            box-shadow: 0 4px 14px -2px rgba(99,102,241,.35);
            transform: translateY(-1px);
        }
        .btn-primary:active:not(:disabled) { transform: scale(0.97); box-shadow: 0 1px 2px rgba(99,102,241,.15); }
        .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; pointer-events: none; }

        .btn-secondary {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 0.625rem;
            font-weight: 500; font-size: 0.875rem;
            color: #374151; background: #fff; border: 1.5px solid #e5e7eb;
            box-shadow: 0 1px 2px rgba(0,0,0,.05);
            transition: all 0.15s ease; cursor: pointer; user-select: none;
            white-space: nowrap; font-family: inherit;
        }
        .btn-secondary:hover:not(:disabled) {
            background: #f9fafb; border-color: #d1d5db;
            box-shadow: 0 2px 8px rgba(0,0,0,.07);
        }
        .btn-secondary:active:not(:disabled) { transform: scale(0.97); }

        .btn-danger {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.625rem 1.5rem; border-radius: 0.75rem;
            font-weight: 600; font-size: 0.9375rem;
            color: #fff; background: #ef4444; border: 1.5px solid #e03e3e;
            box-shadow: 0 1px 3px rgba(239,68,68,.2);
            transition: all 0.2s ease; cursor: pointer; user-select: none;
            white-space: nowrap; font-family: inherit;
        }
        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
            box-shadow: 0 4px 14px -2px rgba(239,68,68,.3);
            transform: translateY(-1px);
        }
        .btn-danger:active:not(:disabled) { transform: scale(0.97); }

        .btn-success {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.5rem 1rem; border-radius: 0.625rem;
            font-weight: 500; font-size: 0.875rem;
            color: #fff; background: #10b981; border: 1.5px solid #059669;
            box-shadow: 0 1px 2px rgba(16,185,129,.2);
            transition: all 0.15s ease; cursor: pointer; user-select: none;
            font-family: inherit;
        }
        .btn-success:hover:not(:disabled) { background: #059669; }
        .btn-success:active:not(:disabled) { transform: scale(0.97); }

        .btn-ghost {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.375rem;
            padding: 0.4rem 0.75rem; border-radius: 0.5rem;
            font-weight: 500; font-size: 0.75rem;
            color: rgba(255,255,255,.85);
            background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12);
            transition: all 0.15s ease; cursor: pointer; user-select: none;
            font-family: inherit;
        }
        .btn-ghost:hover { background: rgba(255,255,255,.18); border-color: rgba(255,255,255,.22); color: #fff; }
        .btn-ghost:active { transform: scale(0.96); }

        .btn-ghost-danger {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.375rem;
            padding: 0.4rem 0.75rem; border-radius: 0.5rem;
            font-weight: 500; font-size: 0.75rem;
            color: rgba(255,255,255,.9);
            background: rgba(239,68,68,.35); border: 1px solid rgba(239,68,68,.25);
            transition: all 0.15s ease; cursor: pointer; user-select: none;
            font-family: inherit;
        }
        .btn-ghost-danger:hover { background: rgba(239,68,68,.55); border-color: rgba(239,68,68,.4); color: #fff; }
        .btn-ghost-danger:active { transform: scale(0.96); }

        .btn-export {
            display: flex; flex-direction: column; align-items: center; gap: 0.625rem;
            padding: 1.5rem 1rem; border-radius: 1rem;
            font-weight: 500; font-size: 0.875rem;
            color: #374151; background: #fff;
            border: 2px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,.04);
            transition: all 0.2s ease; cursor: pointer; user-select: none;
            font-family: inherit;
        }
        .btn-export:hover {
            border-color: #a5b4fc; color: #4338ca; background: #eef2ff;
            box-shadow: 0 8px 24px rgba(99,102,241,.1);
            transform: translateY(-3px);
        }
        .btn-export:active { transform: translateY(-1px) scale(0.98); }

        /* â”€â”€â”€ æ»šåŠ¨æ¡ â”€â”€â”€ */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 8px; }

        /* â”€â”€â”€ è®¾ç½®æ§ä»¶ â”€â”€â”€ */
        .range-input {
            @apply w-full h-2 bg-gray-200 rounded-full appearance-none cursor-pointer;
        }
        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px; border-radius: 50%;
            background: #4f46e5; border: 3px solid white;
            box-shadow: 0 2px 6px rgba(79,70,229,.4);
            cursor: pointer;
        }

        /* â”€â”€â”€ åˆ é™¤åŠ¨ç”» â”€â”€â”€ */
        .slide-card.removing {
            transform: scale(.75); opacity: 0;
            transition: transform .3s ease, opacity .3s ease;
        }
        .slide-card.restoring {
            animation: popIn .35s ease forwards;
        }
        @keyframes popIn { from{transform:scale(.7);opacity:0} to{transform:scale(1);opacity:1} }

        /* â”€â”€â”€ å›æ”¶ç«™æŠ½å±‰ â”€â”€â”€ */
        .recycle-drawer {
            position: fixed; top: 0; right: 0; bottom: 0; width: 380px; max-width: 92vw;
            background: white; z-index: 60;
            box-shadow: -8px 0 40px rgba(0,0,0,.15);
            transform: translateX(100%); transition: transform .35s cubic-bezier(.4,0,.2,1);
            display: flex; flex-direction: column;
        }
        .recycle-drawer.open { transform: translateX(0); }
        .recycle-backdrop {
            position: fixed; inset: 0; z-index: 55;
            background: rgba(0,0,0,.3); backdrop-filter: blur(4px);
            opacity: 0; transition: opacity .3s; pointer-events: none;
        }
        .recycle-backdrop.open { opacity: 1; pointer-events: auto; }
        .recycle-item {
            @apply flex items-center gap-3 p-3 rounded-xl border-2 border-transparent hover:border-brand-300 hover:bg-brand-50 transition cursor-pointer;
        }
        .recycle-item img {
            width: 90px; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px;
            flex-shrink: 0;
        }

        /* â”€â”€â”€ æ ‡ç­¾é¡µç³»ç»Ÿ â”€â”€â”€ */
        .tab-bar {
            display: flex; align-items: stretch; gap: 2px;
            background: #e2e8f0; border-radius: 12px 12px 0 0;
            padding: 4px 4px 0; overflow-x: auto;
        }
        .tab-item {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 14px; border-radius: 8px 8px 0 0;
            font-size: 13px; font-weight: 500; color: #64748b;
            background: #f1f5f9; cursor: pointer;
            transition: all .15s ease; white-space: nowrap;
            user-select: none; max-width: 220px; min-width: 0;
            border: 1px solid transparent; border-bottom: none;
            position: relative;
        }
        .tab-item:hover { background: #fff; color: #334155; }
        .tab-item.active {
            background: #fff; color: #4f46e5; font-weight: 600;
            border-color: #e2e8f0;
            box-shadow: 0 -2px 8px rgba(99,102,241,.08);
        }
        .tab-item .tab-title {
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            max-width: 140px;
        }
        .tab-item .tab-close {
            width: 18px; height: 18px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 11px; color: #94a3b8;
            transition: all .15s; flex-shrink: 0;
        }
        .tab-item .tab-close:hover { background: #fee2e2; color: #ef4444; }
        .tab-item .tab-status {
            width: 8px; height: 8px; border-radius: 50%;
            flex-shrink: 0;
        }
        .tab-status.idle { background: #d1d5db; }
        .tab-status.running { background: #f59e0b; animation: pulse-dot 1.2s ease infinite; }
        .tab-status.done { background: #10b981; }
        .tab-status.error { background: #ef4444; }
        .tab-status.cancelled { background: #f59e0b; }
        @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(.7)} }

        .tab-add {
            display: flex; align-items: center; justify-content: center;
            width: 32px; height: 32px; border-radius: 8px 8px 0 0;
            font-size: 18px; color: #94a3b8; cursor: pointer;
            background: transparent; transition: all .15s; flex-shrink: 0;
            align-self: flex-end; margin-bottom: 0;
        }
        .tab-add:hover { background: #fff; color: #4f46e5; }
        .tab-add.disabled { opacity: .35; pointer-events: none; }

        .tab-content-area {
            background: #fff; border: 1px solid #e2e8f0; border-top: none;
            border-radius: 0 0 12px 12px; min-height: 200px;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* â”€â”€â”€ èµ„æºç›‘æ§æ¡ â”€â”€â”€ */
        .resource-bar {
            display: flex; align-items: center; gap: 16px;
            padding: 8px 16px; font-size: 12px; color: #64748b;
            background: linear-gradient(90deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }
        .resource-item {
            display: flex; align-items: center; gap: 6px;
        }
        .resource-item .res-label { color: #94a3b8; }
        .resource-item .res-value { font-weight: 600; font-variant-numeric: tabular-nums; }
        .res-bar-mini {
            width: 50px; height: 6px; background: #e2e8f0; border-radius: 3px; overflow: hidden;
        }
        .res-bar-mini-fill {
            height: 100%; border-radius: 3px; transition: width .5s ease, background .3s;
        }
        .res-warn { color: #ef4444 !important; }
        .resource-warning-banner {
            background: #fef2f2; border: 1px solid #fecaca; color: #991b1b;
            padding: 8px 16px; font-size: 13px; text-align: center;
            display: none;
        }
        .resource-warning-banner.visible { display: block; }

        /* â”€â”€â”€ é”™è¯¯è¯¦æƒ…å¼¹çª— â”€â”€â”€ */
        .error-modal-backdrop {
            position: fixed; inset: 0; z-index: 9000;
            background: rgba(15,23,42,0.6); backdrop-filter: blur(4px);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity .25s;
        }
        .error-modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .error-modal {
            background: white; border-radius: 16px; max-width: 560px; width: 92%;
            box-shadow: 0 25px 60px rgba(0,0,0,.25); padding: 32px;
            transform: scale(.95); transition: transform .25s;
        }
        .error-modal-backdrop.visible .error-modal { transform: scale(1); }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50/40 min-h-screen pb-8">

    <!-- Toast å®¹å™¨ -->
    <div id="toasts" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none" style="max-width:360px"></div>

    <!-- é”™è¯¯è¯¦æƒ…å¼¹çª— -->
    <div id="errorModal" class="error-modal-backdrop" onclick="if(event.target===this)closeErrorModal()">
        <div class="error-modal">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3"><span class="text-3xl">âŒ</span><h2 class="text-lg font-bold text-gray-900" id="errorModalTitle">å‡ºé”™äº†</h2></div>
                <button onclick="closeErrorModal()" class="text-gray-400 hover:text-gray-700 text-xl leading-none">&times;</button>
            </div>
            <div id="errorModalMessage" class="text-sm text-gray-700 mb-3 leading-relaxed"></div>
            <div id="errorModalHint" class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-800 mb-4 hidden">
                <p class="font-semibold mb-1">ğŸ’¡ å»ºè®®æ“ä½œï¼š</p>
                <p id="errorModalHintText"></p>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <button onclick="closeErrorModal()" class="btn-secondary" style="min-width:80px">å…³é—­</button>
                <a id="errorModalIssueLink" href="#" target="_blank" class="btn-primary flex items-center gap-2" style="text-decoration:none;font-size:13px">
                    ğŸ› æäº¤ Issue åé¦ˆ
                </a>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• Header â•â•â•â•â•â•â• -->
    <header class="bg-gradient-to-r from-brand-700 via-brand-600 to-blue-500 text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
                    <span class="text-3xl">ğŸ“Š</span> å½±å¹»æ™ºæ (VidSlide)
                    <span class="text-xs font-normal bg-white/15 px-2 py-0.5 rounded-full ml-2">v0.2 å¤šä»»åŠ¡</span>
                </h1>
                <p class="text-brand-200 text-sm mt-1">ä»å½•æ’­è§†é¢‘ä¸­ä¸€é”®æå– PPT Â· å¤šä»»åŠ¡å¹¶è¡Œ Â· æ‹–æ‹½æ’åº Â· æ‰“åŒ…å¯¼å‡º</p>
            </div>
            <div class="flex gap-2">
                <button onclick="cleanupAll()" class="btn-ghost" title="æ¸…ç©ºæ‰€æœ‰æ ‡ç­¾é¡µç¼“å­˜">
                    ğŸ—‘ï¸ å…¨éƒ¨æ¸…ç©º
                </button>
                <button onclick="shutdownServer()" class="btn-ghost-danger" title="å…³é—­æœåŠ¡å¹¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶">
                    â» å…³é—­å·¥å…·
                </button>
            </div>
        </div>
    </header>

    <!-- â•â•â•â•â•â•â• èµ„æºç›‘æ§æ¡ â•â•â•â•â•â•â• -->
    <div class="resource-bar" id="resourceBar">
        <div class="resource-item">
            <span class="res-label">CPU</span>
            <div class="res-bar-mini"><div id="resCpuBar" class="res-bar-mini-fill bg-blue-400" style="width:0%"></div></div>
            <span class="res-value" id="resCpuText">--%</span>
        </div>
        <div class="resource-item">
            <span class="res-label">å†…å­˜</span>
            <div class="res-bar-mini"><div id="resMemBar" class="res-bar-mini-fill bg-emerald-400" style="width:0%"></div></div>
            <span class="res-value" id="resMemText">--%</span>
        </div>
        <div class="resource-item">
            <span class="res-label">ç£ç›˜å‰©ä½™</span>
            <span class="res-value" id="resDiskText">-- GB</span>
        </div>
        <div class="resource-item" style="border-left:1px solid #d1d5db;padding-left:12px">
            <span class="res-label">æ´»è·ƒä»»åŠ¡</span>
            <span class="res-value" id="resTaskText">0</span>
        </div>
        <div class="resource-item">
            <span class="res-label">æ ‡ç­¾é¡µ</span>
            <span class="res-value" id="resTabText">0/3</span>
        </div>
    </div>
    <div class="resource-warning-banner" id="resourceWarning"></div>

    <!-- â•â•â•â•â•â•â• ä¸»åŒºåŸŸ â•â•â•â•â•â•â• -->
    <main class="max-w-7xl mx-auto px-6 py-6">

        <!-- æ ‡ç­¾æ  -->
        <div class="tab-bar" id="tabBar">
            <!-- æ ‡ç­¾ä¼šåŠ¨æ€æ’å…¥ -->
            <div class="tab-add" id="tabAddBtn" onclick="addNewTab()" title="æ–°å»ºæ ‡ç­¾é¡µ (æœ€å¤š3ä¸ª)">ï¼‹</div>
        </div>

        <!-- æ ‡ç­¾é¡µå†…å®¹åŒº -->
        <div class="tab-content-area" id="tabContentArea">
            <!-- æ¯ä¸ªæ ‡ç­¾é¡µçš„å†…å®¹é¢æ¿ä¼šåŠ¨æ€æ’å…¥ -->
            <div id="emptyHint" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <span class="text-5xl mb-4">ğŸ“‚</span>
                <p class="text-lg font-medium mb-2">ç‚¹å‡»ä¸Šæ–¹ ï¼‹ æ–°å»ºä¸€ä¸ªæ ‡ç­¾é¡µå¼€å§‹å·¥ä½œ</p>
                <p class="text-sm">æ¯ä¸ªæ ‡ç­¾é¡µå¯ç‹¬ç«‹å¤„ç†ä¸€ä¸ªè§†é¢‘ï¼Œæœ€å¤šåŒæ—¶å¼€ 3 ä¸ª</p>
            </div>
        </div>
    </main>

    <!-- â•â•â•â•â•â•â• åº•éƒ¨ â•â•â•â•â•â•â• -->
    <footer class="max-w-5xl mx-auto px-4 pb-8 text-center">
        <p class="text-xs text-gray-300">ğŸ”’ æ‰€æœ‰æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°ã€‚å…³é—­æµè§ˆå™¨é¡µé¢åæœåŠ¡ä¼šåœ¨ 20 ç§’å†…è‡ªåŠ¨é€€å‡ºå¹¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€‚</p>
        <p class="text-xs text-gray-300 mt-1">å½±å¹»æ™ºæ (VidSlide) v0.2.0 å¤šä»»åŠ¡ç‰ˆ Â· Made by PWO-CHINA</p>
    </footer>

    <!-- â•â•â•â•â•â•â• å›æ”¶ç«™æŠ½å±‰ â•â•â•â•â•â•â• -->
    <div id="recycleBackdrop" class="recycle-backdrop" onclick="closeRecycleBin()"></div>
    <div id="recycleDrawer" class="recycle-drawer">
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                ğŸ—‘ï¸ å›æ”¶ç«™ <span id="recycleDrawerCount" class="text-sm font-normal text-gray-400"></span>
            </h3>
            <div class="flex gap-2">
                <button onclick="restoreAll()" id="btnRestoreAll" class="btn-secondary" style="font-size:.75rem;padding:.375rem .75rem;color:#4f46e5;border-color:#c7d2fe;background:#eef2ff">
                    â†©ï¸ å…¨éƒ¨æ¢å¤
                </button>
                <button onclick="closeRecycleBin()" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 flex items-center justify-center transition">âœ•</button>
            </div>
        </div>
        <div id="recycleList" class="flex-1 overflow-y-auto p-4 space-y-2">
            <p id="recycleEmpty" class="text-center text-gray-400 text-sm py-12">å›æ”¶ç«™æ˜¯ç©ºçš„</p>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â• å›¾ç‰‡é¢„è§ˆå¼¹çª— â•â•â•â•â•â•â• -->
    <div id="previewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop" onclick="if(event.target===this)hidePreview()">
        <button onclick="hidePreview()" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-white/10 hover:bg-white/25 text-white text-xl flex items-center justify-center transition">âœ•</button>
        <button onclick="prevPreview()" id="btnPrevPreview" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/25 text-white text-2xl flex items-center justify-center transition">â—€</button>
        <button onclick="nextPreview()" id="btnNextPreview" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/25 text-white text-2xl flex items-center justify-center transition">â–¶</button>
        <img id="previewImage" class="max-w-[90vw] max-h-[85vh] rounded-lg shadow-2xl object-contain select-none" draggable="false">
        <div id="previewCounter" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-4 py-1.5 rounded-full backdrop-blur"></div>
    </div>

    <!-- â•â•â•â•â•â•â• æ ‡ç­¾é¡µå†…å®¹æ¨¡æ¿ï¼ˆhiddenï¼ŒJS å…‹éš†ä½¿ç”¨ï¼‰â•â•â•â•â•â•â• -->
    <template id="tabPaneTemplate">
        <div class="tab-pane p-6 space-y-6">
            <!-- æ­¥éª¤ 1: é€‰æ‹©è§†é¢‘ -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">1</span>
                    é€‰æ‹©è§†é¢‘æ–‡ä»¶
                </h2>
                <div class="flex flex-col sm:flex-row gap-3 items-stretch">
                    <button class="btn-primary shrink-0 js-btn-select-video">ğŸ“ æµè§ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶</button>
                    <div class="relative flex-1">
                        <input type="text" class="js-video-path-input w-full h-full px-4 py-3 text-sm rounded-2xl border-2 border-gray-200 focus:border-brand-400 focus:ring-4 focus:ring-brand-100 outline-none transition bg-gray-50 placeholder-gray-400" placeholder='ç²˜è´´è·¯å¾„ï¼Œæ”¯æŒå¼•å·åŒ…è£¹ï¼Œå¦‚ "D:\video\lecture.mp4"'>
                        <button class="js-btn-confirm-path absolute right-2 top-1/2 -translate-y-1/2 text-xs text-white bg-brand-500 hover:bg-brand-600 font-medium px-3 py-1.5 rounded-lg transition shadow-sm">ç¡®è®¤ â†µ</button>
                    </div>
                </div>
                <div class="js-video-info hidden mt-3 px-4 py-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                    <p class="text-sm text-emerald-800 flex items-center gap-2">
                        <span class="text-lg">âœ…</span>
                        <span class="js-video-path-display font-mono text-xs break-all"></span>
                    </p>
                </div>
            </section>

            <!-- æ­¥éª¤ 2: å‚æ•°è®¾ç½® -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">2</span>
                    æå–å‚æ•°
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">åœºæ™¯æ£€æµ‹çµæ•åº¦</label>
                        <input type="range" min="1" max="15" step="0.5" value="5" class="range-input js-threshold">
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>æ•æ„Ÿ (1)</span>
                            <span class="text-sm font-bold text-brand-600 js-threshold-val">5</span>
                            <span>ä¿å®ˆ (15)</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-use-roi">
                            PPT å½•å±è£å‰ª
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed">å¯ç”¨åå¿½ç•¥å·¦ä¾§ç¼©ç•¥å›¾æ å’Œé¡¶éƒ¨å·¥å…·æ </p>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-enable-history">
                            å†å²è®°å¿†æ± 
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed">é˜²æ­¢ Aâ†’Bâ†’A è·³é¡µå¯¼è‡´é‡å¤æå–</p>
                        <div class="js-max-history-group items-center gap-2 text-sm text-gray-600" style="display:none">
                            <span>å®¹é‡:</span>
                            <input type="number" value="5" min="2" max="20" class="w-16 px-2 py-1 text-sm rounded-lg border border-gray-200 text-center js-max-history">
                            <span class="text-xs text-gray-400">å¼ </span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                        <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-fast-mode">
                        âš¡ å¿«é€Ÿæ¨¡å¼
                    </label>
                    <p class="text-xs text-gray-400 leading-relaxed mt-1">å°†æ¯”è¾ƒåˆ†è¾¨ç‡é™è‡³ 480p ä»¥åŠ é€Ÿæ£€æµ‹ï¼ˆä¸å½±å“è¾“å‡ºå›¾ç‰‡è´¨é‡ï¼‰</p>
                </div>
            </section>

            <!-- æ­¥éª¤ 3: æå– -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">3</span>
                    æå–å¹»ç¯ç‰‡
                </h2>
                <div class="flex items-center gap-3">
                    <button class="btn-primary js-btn-extract" disabled>â–¶ï¸ å¼€å§‹æå–å¹»ç¯ç‰‡</button>
                    <button class="btn-danger hidden js-btn-cancel">â¹ï¸ å–æ¶ˆæå–</button>
                    <span class="text-sm text-gray-500 js-extract-status"></span>
                </div>
                <div class="js-progress-section hidden mt-5 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 font-medium js-progress-message">æ­£åœ¨åˆå§‹åŒ–â€¦</span>
                        <span class="font-bold text-brand-600 text-lg tabular-nums js-progress-pct">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill js-progress-bar" style="width:0%"></div>
                    </div>
                    <p class="text-xs text-gray-400 js-progress-hint">æå–ä¸­ï¼Œè¯·å‹¿å…³é—­æ­¤é¡µé¢â€¦</p>
                </div>
            </section>

            <!-- æ­¥éª¤ 4: ç”»å»Šç®¡ç† -->
            <section class="card hidden js-gallery-section">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">4</span>
                        å›¾ç‰‡ç®¡ç†
                        <span class="text-sm font-normal text-gray-400 ml-2 js-image-count"></span>
                    </h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button class="btn-secondary text-sm hidden js-btn-recycle-bin">
                            ğŸ—‘ï¸ å›æ”¶ç«™ <span class="bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 ml-1 js-recycle-count"></span>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-4 flex items-center gap-4">
                    <span>ğŸ–±ï¸ æ‹–æ‹½è°ƒæ•´é¡ºåº</span>
                    <span>ğŸ” ç‚¹å‡»é¢„è§ˆå¤§å›¾</span>
                    <span>âŒ æ‚¬åœæ˜¾ç¤ºåˆ é™¤</span>
                    <span>âŒ¨ï¸ Ctrl+Z æ’¤é”€åˆ é™¤</span>
                </p>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 js-gallery"></div>
            </section>

            <!-- æ­¥éª¤ 5: æ‰“åŒ…å¯¼å‡º -->
            <section class="card hidden js-export-section">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">5</span>
                    æ‰“åŒ…å¯¼å‡º
                </h2>
                <p class="text-sm text-gray-500 mb-5">å°†å½“å‰æ’å¥½åºçš„å›¾ç‰‡æ‰“åŒ…ä¸‹è½½</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button class="btn-export js-btn-pdf">
                        <span class="text-3xl">ğŸ“„</span>
                        <span class="text-base font-bold">ç”Ÿæˆ PDF</span>
                        <span class="text-xs text-gray-400 font-normal">é€‚åˆæ‰“å°å’Œé˜…è¯»</span>
                    </button>
                    <button class="btn-export js-btn-pptx">
                        <span class="text-3xl">ğŸ“Š</span>
                        <span class="text-base font-bold">ç”Ÿæˆ PPTX</span>
                        <span class="text-xs text-gray-400 font-normal">å¯ç¼–è¾‘çš„æ¼”ç¤ºæ–‡ç¨¿</span>
                    </button>
                    <button class="btn-export js-btn-zip">
                        <span class="text-3xl">ğŸ“¦</span>
                        <span class="text-base font-bold">æ‰“åŒ… ZIP</span>
                        <span class="text-xs text-gray-400 font-normal">åŸå›¾æ‰“åŒ…å‹ç¼©</span>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-3">ğŸ’¡ å¯¼å‡ºçš„æ–‡ä»¶ä¼šä¿å­˜åˆ°æµè§ˆå™¨çš„é»˜è®¤<b>ä¸‹è½½æ–‡ä»¶å¤¹</b>ä¸­</p>
                <div class="hidden mt-5 space-y-2 js-download-section"></div>
            </section>
        </div>
    </template>

    <script>
    // ============================================================
    //  å…¨å±€åº”ç”¨çŠ¶æ€
    // ============================================================
    const G = {
        tabs: {},          // sid -> TabState
        activeTabId: null,
        maxSessions: 3,
        previewTabId: null,
        previewIndex: -1,
    };

    // æ¯ä¸ªæ ‡ç­¾é¡µçš„ç‹¬ç«‹çŠ¶æ€
    class TabState {
        constructor(sid) {
            this.sid = sid;
            this.videoPath = '';
            this.images = [];
            this.deletedStack = [];
            this.isExtracting = false;
            this.pollTimer = null;
            this.sortable = null;
            this.hasWork = false;
            this.downloadLinks = [];
        }
    }

    // ============================================================
    //  API å·¥å…·
    // ============================================================
    async function api(path, opts = {}) {
        try {
            const timeout = path.includes('select-video') ? 180000 : 60000;
            const controller = new AbortController();
            const timer = setTimeout(() => controller.abort(), timeout);
            opts.signal = controller.signal;
            const resp = await fetch(path, opts);
            clearTimeout(timer);
            if (!resp.ok) {
                const text = await resp.text();
                let parsed = {};
                try { parsed = JSON.parse(text); } catch { parsed = { message: text }; }
                const msg = parsed.message || resp.statusText;
                // å¦‚æœåç«¯è¿”å›äº† hint å­—æ®µï¼Œå¼¹å‡ºè¯¦ç»†é”™è¯¯å¼¹çª—
                if (parsed.hint) {
                    showErrorModal('è¯·æ±‚å¤±è´¥', msg, parsed.hint);
                } else {
                    showToast('æœåŠ¡å™¨é”™è¯¯: ' + msg, 'error');
                }
                return { success: false, message: msg, hint: parsed.hint };
            }
            const data = await resp.json();
            // å¯¹äº success=false ä¸”æœ‰ hint çš„å“åº”ï¼Œå¼¹å‡ºé”™è¯¯å¼¹çª—
            if (!data.success && data.hint) {
                showErrorModal(data.message, data.hint, null);
                // hint å·²åœ¨å¼¹çª—ä¸­æ˜¾ç¤ºï¼Œç”¨ toast åšç®€çŸ­æé†’
            }
            return data;
        } catch (e) {
            if (e.name === 'AbortError') {
                showToast('è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•', 'error');
                return { success: false, message: 'è¯·æ±‚è¶…æ—¶' };
            }
            showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
            if (e instanceof TypeError && e.message.includes('fetch')) {
                sendHeartbeat();
            }
            console.error('[API Error]', path, e);
            return { success: false, message: e.message };
        }
    }

    // ============================================================
    //  Toast é€šçŸ¥
    // ============================================================
    function showToast(msg, type = 'info', duration = 3500) {
        const colors = { info: 'bg-blue-500', success: 'bg-emerald-500', error: 'bg-red-500', warning: 'bg-amber-500' };
        const icons = { info:'â„¹ï¸', success:'âœ…', error:'âŒ', warning:'âš ï¸' };
        const el = document.createElement('div');
        el.className = `${colors[type]||colors.info} text-white px-5 py-3 rounded-xl shadow-lg text-sm font-medium pointer-events-auto flex items-center gap-2 toast-enter`;
        el.innerHTML = `<span>${icons[type]||''}</span><span>${msg}</span>`;
        document.getElementById('toasts').appendChild(el);
        setTimeout(() => {
            el.classList.remove('toast-enter');
            el.classList.add('toast-leave');
            setTimeout(() => el.remove(), 300);
        }, duration);
    }

    // ============================================================
    //  é”™è¯¯è¯¦æƒ…å¼¹çª—ï¼ˆå« Issue æäº¤ï¼‰
    // ============================================================
    function showErrorModal(title, message, hint) {
        document.getElementById('errorModalTitle').textContent = title || 'å‡ºé”™äº†';
        document.getElementById('errorModalMessage').textContent = message || 'æœªçŸ¥é”™è¯¯';
        const hintBox = document.getElementById('errorModalHint');
        if (hint) {
            document.getElementById('errorModalHintText').textContent = hint;
            hintBox.classList.remove('hidden');
        } else {
            hintBox.classList.add('hidden');
        }
        // æ„å»º Issue é¢„å¡«é“¾æ¥
        const issueTitle = encodeURIComponent(`[Bug] ${title || 'é”™è¯¯æŠ¥å‘Š'}`);
        const issueBody = encodeURIComponent(
            `## é”™è¯¯æè¿°\n${message}\n\n` +
            (hint ? `## å»ºè®®\n${hint}\n\n` : '') +
            `## ç¯å¢ƒä¿¡æ¯\n- æµè§ˆå™¨: ${navigator.userAgent}\n- æ—¶é—´: ${new Date().toLocaleString()}\n` +
            `\n## å¤ç°æ­¥éª¤\n1. \n2. \n3. \n`
        );
        document.getElementById('errorModalIssueLink').href =
            `https://github.com/PWO-CHINA/VidSlide/issues/new?title=${issueTitle}&body=${issueBody}`;
        document.getElementById('errorModal').classList.add('visible');
    }
    function closeErrorModal() {
        document.getElementById('errorModal').classList.remove('visible');
    }

    // ============================================================
    //  æ ‡ç­¾é¡µç®¡ç†
    // ============================================================
    function getTabEl(sid) {
        return document.querySelector(`.tab-item[data-sid="${sid}"]`);
    }
    function getPane(sid) {
        return document.querySelector(`.tab-pane[data-sid="${sid}"]`);
    }
    function q(sid, cls) {
        const pane = getPane(sid);
        return pane ? pane.querySelector('.' + cls) : null;
    }

    async function addNewTab() {
        const count = Object.keys(G.tabs).length;
        if (count >= G.maxSessions) {
            showToast(`æœ€å¤šåªèƒ½å¼€ ${G.maxSessions} ä¸ªæ ‡ç­¾é¡µ`, 'warning');
            return;
        }

        const data = await api('/api/session/create', { method: 'POST' });
        if (!data.success) {
            showToast(data.message, 'error');
            return;
        }

        const sid = data.session_id;
        G.tabs[sid] = new TabState(sid);
        createTabUI(sid, 'æ–°ä»»åŠ¡');
        switchTab(sid);
        updateTabAddBtn();
        showToast('å·²æ–°å»ºæ ‡ç­¾é¡µ', 'success', 2000);
    }

    function createTabUI(sid, title) {
        // åˆ›å»ºæ ‡ç­¾
        const tab = document.createElement('div');
        tab.className = 'tab-item';
        tab.dataset.sid = sid;
        tab.innerHTML = `
            <span class="tab-status idle"></span>
            <span class="tab-title" title="${title}">${title}</span>
            <span class="tab-close" onclick="event.stopPropagation();closeTab('${sid}')" title="å…³é—­æ­¤æ ‡ç­¾é¡µ">âœ•</span>
        `;
        tab.addEventListener('click', () => switchTab(sid));
        document.getElementById('tabAddBtn').before(tab);

        // åˆ›å»ºå†…å®¹é¢æ¿ï¼ˆä»æ¨¡æ¿å…‹éš†ï¼‰
        const template = document.getElementById('tabPaneTemplate');
        const pane = template.content.cloneNode(true).firstElementChild;
        pane.dataset.sid = sid;
        bindPaneEvents(sid, pane);
        document.getElementById('tabContentArea').appendChild(pane);

        // éšè—ç©ºæç¤º
        const hint = document.getElementById('emptyHint');
        if (hint) hint.style.display = 'none';
    }

    function bindPaneEvents(sid, pane) {
        // é€‰æ‹©è§†é¢‘æŒ‰é’®
        pane.querySelector('.js-btn-select-video').addEventListener('click', () => selectVideo(sid));
        // ç¡®è®¤è·¯å¾„æŒ‰é’®
        pane.querySelector('.js-btn-confirm-path').addEventListener('click', () => confirmManualPath(sid));
        // è·¯å¾„è¾“å…¥æ¡†å›è½¦ / ç²˜è´´
        const pathInput = pane.querySelector('.js-video-path-input');
        pathInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') confirmManualPath(sid); });
        pathInput.addEventListener('paste', () => setTimeout(() => autoConfirmPath(sid), 100));
        // çµæ•åº¦æ»‘æ¡
        const thSlider = pane.querySelector('.js-threshold');
        thSlider.addEventListener('input', () => {
            pane.querySelector('.js-threshold-val').textContent = thSlider.value;
        });
        // å†å²æ± å¼€å…³
        const histCb = pane.querySelector('.js-enable-history');
        histCb.addEventListener('change', () => {
            pane.querySelector('.js-max-history-group').style.display = histCb.checked ? 'flex' : 'none';
        });
        // æå– / å–æ¶ˆ
        pane.querySelector('.js-btn-extract').addEventListener('click', () => startExtraction(sid));
        pane.querySelector('.js-btn-cancel').addEventListener('click', () => cancelExtraction(sid));
        // å¯¼å‡ºæŒ‰é’®
        pane.querySelector('.js-btn-pdf').addEventListener('click', () => packageImages(sid, 'pdf'));
        pane.querySelector('.js-btn-pptx').addEventListener('click', () => packageImages(sid, 'pptx'));
        pane.querySelector('.js-btn-zip').addEventListener('click', () => packageImages(sid, 'zip'));
        // å›æ”¶ç«™æŒ‰é’®
        pane.querySelector('.js-btn-recycle-bin').addEventListener('click', () => openRecycleBin(sid));
    }

    function switchTab(sid) {
        // å–æ¶ˆä¹‹å‰çš„æ´»è·ƒæ€
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        // æ¿€æ´»æ–°æ ‡ç­¾
        const tab = getTabEl(sid);
        const pane = getPane(sid);
        if (tab) tab.classList.add('active');
        if (pane) pane.classList.add('active');
        G.activeTabId = sid;
    }

    async function closeTab(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        // æœ‰æœªå¯¼å‡ºå·¥ä½œæ—¶ç¡®è®¤
        if (ts.images.length > 0 && ts.downloadLinks.length === 0) {
            if (!confirm('è¯¥æ ‡ç­¾é¡µæœ‰æœªå¯¼å‡ºçš„å›¾ç‰‡ï¼Œç¡®å®šå…³é—­ï¼Ÿ')) return;
        }
        // å¦‚æœæ­£åœ¨æå–ï¼Œå…ˆå–æ¶ˆ
        if (ts.isExtracting) {
            await api(`/api/session/${sid}/cancel`, { method: 'POST' });
        }
        if (ts.pollTimer) clearInterval(ts.pollTimer);
        // é€šçŸ¥åç«¯å…³é—­ä¼šè¯
        await api(`/api/session/${sid}/close`, { method: 'POST' });
        // ç§»é™¤ UI
        const tab = getTabEl(sid);
        const pane = getPane(sid);
        if (tab) tab.remove();
        if (pane) pane.remove();
        delete G.tabs[sid];
        // åˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾
        const remaining = Object.keys(G.tabs);
        if (remaining.length > 0) {
            switchTab(remaining[remaining.length - 1]);
        } else {
            G.activeTabId = null;
            const hint = document.getElementById('emptyHint');
            if (hint) hint.style.display = '';
        }
        updateTabAddBtn();
        showToast('æ ‡ç­¾é¡µå·²å…³é—­', 'info', 2000);
    }

    function updateTabAddBtn() {
        const btn = document.getElementById('tabAddBtn');
        const count = Object.keys(G.tabs).length;
        btn.classList.toggle('disabled', count >= G.maxSessions);
        btn.title = count >= G.maxSessions ? `å·²è¾¾ä¸Šé™ (${G.maxSessions})` : 'æ–°å»ºæ ‡ç­¾é¡µ';
    }

    function updateTabStatus(sid, status) {
        const tab = getTabEl(sid);
        if (!tab) return;
        const dot = tab.querySelector('.tab-status');
        if (dot) {
            dot.className = 'tab-status ' + status;
        }
    }

    function updateTabTitle(sid, title) {
        const tab = getTabEl(sid);
        if (!tab) return;
        const span = tab.querySelector('.tab-title');
        if (span) {
            const short = title.length > 18 ? title.substring(0, 18) + 'â€¦' : title;
            span.textContent = short;
            span.title = title;
        }
    }

    // ============================================================
    //  è§†é¢‘é€‰æ‹©
    // ============================================================
    async function selectVideo(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const btn = q(sid, 'js-btn-select-video');
        btn.disabled = true;
        btn.textContent = 'â³ è¯·åœ¨å¼¹å‡ºçª—å£ä¸­é€‰æ‹©æ–‡ä»¶â€¦';
        const data = await api('/api/select-video', { method: 'POST' });
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“ æµè§ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶';
        if (data.success && data.path) {
            setVideoPath(sid, data.path);
        } else if (data.message && data.message !== 'æœªé€‰æ‹©æ–‡ä»¶') {
            showToast(data.message, 'warning');
        }
    }

    function confirmManualPath(sid) {
        let v = q(sid, 'js-video-path-input').value.trim();
        v = v.replace(/^["']+|["']+$/g, '').trim();
        if (v) {
            q(sid, 'js-video-path-input').value = v;
            setVideoPath(sid, v);
        }
    }

    function autoConfirmPath(sid) {
        let v = q(sid, 'js-video-path-input').value.trim();
        v = v.replace(/^["']+|["']+$/g, '').trim();
        if (v && (v.endsWith('.mp4') || v.endsWith('.avi') || v.endsWith('.mkv') || v.endsWith('.mov') || v.endsWith('.flv') || v.endsWith('.wmv') || v.includes('\\'))) {
            q(sid, 'js-video-path-input').value = v;
            setVideoPath(sid, v);
        }
    }

    function setVideoPath(sid, p) {
        const ts = G.tabs[sid];
        if (!ts) return;
        ts.videoPath = p;
        q(sid, 'js-video-path-input').value = p;
        q(sid, 'js-video-path-display').textContent = p;
        q(sid, 'js-video-info').classList.remove('hidden');
        q(sid, 'js-btn-extract').disabled = false;
        // æ›´æ–°æ ‡ç­¾å
        const fname = p.split(/[\\/]/).pop() || p;
        updateTabTitle(sid, fname);
        showToast('å·²é€‰æ‹©è§†é¢‘æ–‡ä»¶', 'success');
    }

    // ============================================================
    //  æå–æ§åˆ¶
    // ============================================================
    async function startExtraction(sid) {
        const ts = G.tabs[sid];
        if (!ts || !ts.videoPath) { showToast('è¯·å…ˆé€‰æ‹©è§†é¢‘æ–‡ä»¶', 'warning'); return; }
        if (ts.isExtracting) return;

        if (ts.images.length > 0) {
            if (!confirm('é‡æ–°æå–å°†æ¸…ç©ºå½“å‰ç”»å»Šä¸­çš„æ‰€æœ‰å›¾ç‰‡ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ')) return;
        }

        const pane = getPane(sid);
        const data = await api(`/api/session/${sid}/extract`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                video_path: ts.videoPath,
                threshold: parseFloat(pane.querySelector('.js-threshold').value),
                enable_history: pane.querySelector('.js-enable-history').checked,
                max_history: parseInt(pane.querySelector('.js-max-history').value),
                use_roi: pane.querySelector('.js-use-roi').checked,
                fast_mode: pane.querySelector('.js-fast-mode').checked,
            }),
        });

        if (!data.success) { showToast(data.message, 'error'); return; }

        ts.isExtracting = true;
        ts.images = [];
        ts.deletedStack = [];
        ts.downloadLinks = [];

        q(sid, 'js-btn-extract').classList.add('hidden');
        q(sid, 'js-btn-cancel').classList.remove('hidden');
        q(sid, 'js-progress-section').classList.remove('hidden');
        q(sid, 'js-gallery-section').classList.add('hidden');
        q(sid, 'js-export-section').classList.add('hidden');
        q(sid, 'js-extract-status').textContent = '';
        const dlSec = q(sid, 'js-download-section');
        if (dlSec) { dlSec.innerHTML = ''; dlSec.classList.add('hidden'); }

        updateTabStatus(sid, 'running');
        startPolling(sid);
    }

    async function cancelExtraction(sid) {
        await api(`/api/session/${sid}/cancel`, { method: 'POST' });
        showToast('æ­£åœ¨å–æ¶ˆâ€¦', 'warning');
    }

    function startPolling(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        if (ts.pollTimer) clearInterval(ts.pollTimer);
        let polling = false;
        let _pollInterval = 800; // åˆå§‹é«˜é¢‘è½®è¯¢

        function schedulePoll() {
            ts.pollTimer = setTimeout(async () => {
                if (polling) { schedulePoll(); return; }
                polling = true;
                try {
                    const s = await api(`/api/session/${sid}/progress`);
                    if (!s.status) { polling = false; schedulePoll(); return; }

                    q(sid, 'js-progress-bar').style.width = s.progress + '%';
                    q(sid, 'js-progress-pct').textContent = s.progress + '%';
                    q(sid, 'js-progress-message').textContent = s.message || '';

                    if (s.eta_seconds != null && s.eta_seconds >= 0 && s.status === 'running') {
                        const eta = Math.round(s.eta_seconds);
                        const elapsed = Math.round(s.elapsed_seconds || 0);
                        const etaStr = eta >= 60 ? Math.floor(eta/60)+'åˆ†'+(eta%60)+'ç§’' : eta+'ç§’';
                        const elapsedStr = elapsed >= 60 ? Math.floor(elapsed/60)+'åˆ†'+(elapsed%60)+'ç§’' : elapsed+'ç§’';
                        q(sid, 'js-progress-hint').textContent = 'å·²ç”¨ '+elapsedStr+'ï¼Œé¢„è®¡è¿˜å‰© '+etaStr;
                        _pollInterval = 800; // è¿è¡Œä¸­ï¼šé«˜é¢‘è½®è¯¢
                    } else if (s.status === 'running') {
                        q(sid, 'js-progress-hint').textContent = 'æ­£åœ¨ä¼°ç®—å‰©ä½™æ—¶é—´â€¦';
                        _pollInterval = 800;
                    }

                    if (s.status === 'idle') {
                        stopPolling(sid);
                        ts.isExtracting = false;
                        polling = false;
                        return; // ä¸å† schedule
                    }

                    if (s.status === 'done' || s.status === 'cancelled' || s.status === 'error') {
                        stopPolling(sid);
                        ts.isExtracting = false;
                        q(sid, 'js-btn-extract').classList.remove('hidden');
                        q(sid, 'js-btn-cancel').classList.add('hidden');
                        q(sid, 'js-progress-bar').style.width = '100%';
                        q(sid, 'js-progress-pct').textContent = '100%';
                        updateTabStatus(sid, s.status);

                        if (s.status === 'done') {
                            q(sid, 'js-progress-message').textContent = 'âœ… ' + s.message;
                            showToast(s.message, 'success', 5000);
                            await loadImages(sid);
                        } else if (s.status === 'cancelled') {
                            q(sid, 'js-progress-message').textContent = 'â¹ ' + s.message;
                            showToast(s.message, 'warning');
                            await loadImages(sid);
                        } else {
                            q(sid, 'js-progress-message').textContent = 'âŒ ' + s.message;
                            // æå–å‡ºé”™æ—¶å¼¹å‡ºè¯¦ç»†é”™è¯¯å¼¹çª—ï¼ˆå« Issue æäº¤æŒ‰é’®ï¼‰
                            showErrorModal('æå–å‡ºé”™', s.message,
                                'å¦‚æœé—®é¢˜æŒç»­å‡ºç°ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æäº¤ Issueï¼Œå¼€å‘è€…ä¼šå°½å¿«ä¿®å¤ã€‚');
                        }
                        polling = false;
                        return; // ä¸å† schedule
                    }
                } catch (e) {
                    console.warn('[Poll] è½®è¯¢å¼‚å¸¸:', e);
                } finally {
                    polling = false;
                }
                schedulePoll(); // ç»§ç»­ä¸‹ä¸€è½®
            }, _pollInterval);
        }
        schedulePoll();
    }

    function stopPolling(sid) {
        const ts = G.tabs[sid];
        if (ts && ts.pollTimer) { clearTimeout(ts.pollTimer); ts.pollTimer = null; }
    }

    // ============================================================
    //  ç”»å»Šç®¡ç†
    // ============================================================
    async function loadImages(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const data = await api(`/api/session/${sid}/images`);
        ts.images = data.images || [];
        ts.deletedStack = [];
        ts.hasWork = ts.images.length > 0;
        renderGallery(sid);
        if (ts.images.length > 0) {
            q(sid, 'js-gallery-section').classList.remove('hidden');
            q(sid, 'js-export-section').classList.remove('hidden');
        }
        updateRecycleBinBtn(sid);
    }

    function createCardEl(sid, fn, idx) {
        const card = document.createElement('div');
        card.className = 'slide-card';
        card.dataset.filename = fn;
        card.innerHTML = `
            <img src="/api/session/${sid}/image/${encodeURIComponent(fn)}" alt="Slide ${idx + 1}" loading="lazy">
            <div class="overlay">
                <span class="bg-black/60 text-white text-xs px-2 py-0.5 rounded-full font-bold backdrop-blur">${idx + 1}</span>
                <button class="del-btn w-7 h-7 rounded-full bg-red-500/80 hover:bg-red-600 text-white text-sm flex items-center justify-center backdrop-blur transition" title="åˆ é™¤">âœ•</button>
            </div>
        `;
        card.querySelector('.del-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const gallery = q(sid, 'js-gallery');
            const curIdx = Array.from(gallery.children).indexOf(card);
            if (curIdx >= 0) deleteImage(sid, curIdx);
        });
        card.addEventListener('click', () => {
            const gallery = q(sid, 'js-gallery');
            const curIdx = Array.from(gallery.children).indexOf(card);
            if (curIdx >= 0) showPreview(sid, curIdx);
        });
        return card;
    }

    function renderGallery(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const gallery = q(sid, 'js-gallery');
        gallery.innerHTML = '';
        ts.images.forEach((fn, i) => gallery.appendChild(createCardEl(sid, fn, i)));
        q(sid, 'js-image-count').textContent = `å…± ${ts.images.length} å¼ `;
        initSortable(sid);
    }

    function initSortable(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        if (ts.sortable) ts.sortable.destroy();
        const gallery = q(sid, 'js-gallery');
        ts.sortable = Sortable.create(gallery, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            delay: 120,
            delayOnTouchOnly: true,
            onEnd(evt) {
                const [moved] = ts.images.splice(evt.oldIndex, 1);
                ts.images.splice(evt.newIndex, 0, moved);
                ts.hasWork = true;
                refreshBadges(sid);
            },
        });
    }

    function refreshBadges(sid) {
        const gallery = q(sid, 'js-gallery');
        if (!gallery) return;
        const ts = G.tabs[sid];
        const cards = gallery.children;
        for (let i = 0; i < cards.length; i++) {
            const badge = cards[i].querySelector('.overlay span');
            if (badge) badge.textContent = i + 1;
        }
        if (ts) q(sid, 'js-image-count').textContent = `å…± ${ts.images.length} å¼ `;
    }

    function deleteImage(sid, idx) {
        const ts = G.tabs[sid];
        if (!ts || idx < 0 || idx >= ts.images.length) return;
        const fn = ts.images.splice(idx, 1)[0];
        ts.deletedStack.push({ filename: fn, originalIndex: idx });
        ts.hasWork = true;

        const gallery = q(sid, 'js-gallery');
        const card = gallery.children[idx];
        if (card) {
            card.classList.add('removing');
            card.addEventListener('transitionend', () => { card.remove(); refreshBadges(sid); }, { once: true });
            setTimeout(() => { if (card.parentNode) { card.remove(); refreshBadges(sid); } }, 350);
        }
        updateRecycleBinBtn(sid);
        showToast('å·²ç§»å…¥å›æ”¶ç«™ (Ctrl+Z æ’¤é”€)', 'info', 2000);
    }

    function undoLastDelete(sid) {
        const ts = G.tabs[sid];
        if (!ts || ts.deletedStack.length === 0) return;
        const { filename, originalIndex } = ts.deletedStack.pop();
        restoreImageAt(sid, filename, originalIndex);
        updateRecycleBinBtn(sid);
        showToast(`å·²æ¢å¤ã€Œ${filename}ã€`, 'success', 2000);
    }

    function restoreImageAt(sid, filename, targetIdx) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const insertIdx = Math.min(targetIdx, ts.images.length);
        ts.images.splice(insertIdx, 0, filename);
        ts.hasWork = true;

        const gallery = q(sid, 'js-gallery');
        const card = createCardEl(sid, filename, insertIdx);
        card.classList.add('restoring');
        card.addEventListener('animationend', () => card.classList.remove('restoring'), { once: true });

        if (insertIdx >= gallery.children.length) {
            gallery.appendChild(card);
        } else {
            gallery.insertBefore(card, gallery.children[insertIdx]);
        }
        refreshBadges(sid);
    }

    function updateRecycleBinBtn(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const btn = q(sid, 'js-btn-recycle-bin');
        const cnt = q(sid, 'js-recycle-count');
        if (ts.deletedStack.length > 0) {
            btn.classList.remove('hidden');
            cnt.textContent = ts.deletedStack.length;
        } else {
            btn.classList.add('hidden');
        }
    }

    // â”€â”€ å›æ”¶ç«™æŠ½å±‰ï¼ˆå…¨å±€å…±äº« UIï¼ŒæŒ‰å½“å‰æ ‡ç­¾é¡µæ¸²æŸ“ï¼‰â”€â”€
    let _recycleSid = null;

    function openRecycleBin(sid) {
        _recycleSid = sid;
        renderRecycleList(sid);
        document.getElementById('recycleDrawer').classList.add('open');
        document.getElementById('recycleBackdrop').classList.add('open');
        document.body.style.overflow = 'hidden';
    }

    function closeRecycleBin() {
        document.getElementById('recycleDrawer').classList.remove('open');
        document.getElementById('recycleBackdrop').classList.remove('open');
        document.body.style.overflow = '';
        _recycleSid = null;
    }

    function renderRecycleList(sid) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const list = document.getElementById('recycleList');
        list.innerHTML = '';
        document.getElementById('recycleDrawerCount').textContent = ts.deletedStack.length > 0 ? `(${ts.deletedStack.length} å¼ )` : '';
        document.getElementById('btnRestoreAll').style.display = ts.deletedStack.length > 0 ? '' : 'none';

        if (ts.deletedStack.length === 0) {
            list.innerHTML = '<p class="text-center text-gray-400 text-sm py-12">å›æ”¶ç«™æ˜¯ç©ºçš„</p>';
            return;
        }

        for (let i = ts.deletedStack.length - 1; i >= 0; i--) {
            const { filename, originalIndex } = ts.deletedStack[i];
            const item = document.createElement('div');
            item.className = 'recycle-item';
            item.innerHTML = `
                <img src="/api/session/${sid}/image/${encodeURIComponent(filename)}" alt="${filename}">
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-700 truncate">${filename}</p>
                    <p class="text-xs text-gray-400">åŸä½ç½®: ç¬¬ ${originalIndex + 1} å¼ </p>
                </div>
                <button class="shrink-0 btn text-xs bg-brand-50 text-brand-600 hover:bg-brand-100 border border-brand-200" title="æ¢å¤åˆ°åŸä½ç½®">â†©ï¸ æ¢å¤</button>
            `;
            const stackIdx = i;
            item.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                restoreFromRecycleBin(sid, stackIdx);
            });
            list.appendChild(item);
        }
    }

    function restoreFromRecycleBin(sid, stackIdx) {
        const ts = G.tabs[sid];
        if (!ts || stackIdx < 0 || stackIdx >= ts.deletedStack.length) return;
        const { filename, originalIndex } = ts.deletedStack.splice(stackIdx, 1)[0];
        restoreImageAt(sid, filename, originalIndex);
        updateRecycleBinBtn(sid);
        renderRecycleList(sid);
        showToast(`å·²æ¢å¤ã€Œ${filename}ã€`, 'success', 2000);
        if (ts.deletedStack.length === 0) closeRecycleBin();
    }

    function restoreAll() {
        const sid = _recycleSid;
        const ts = G.tabs[sid];
        if (!ts || ts.deletedStack.length === 0) return;
        const sorted = [...ts.deletedStack].sort((a, b) => a.originalIndex - b.originalIndex);
        ts.deletedStack = [];
        sorted.forEach(({ filename, originalIndex }) => restoreImageAt(sid, filename, originalIndex));
        updateRecycleBinBtn(sid);
        renderRecycleList(sid);
        closeRecycleBin();
        showToast(`å·²æ¢å¤å…¨éƒ¨ ${sorted.length} å¼ å›¾ç‰‡`, 'success');
    }

    // ============================================================
    //  é¢„è§ˆå¼¹çª—
    // ============================================================
    function showPreview(sid, idx) {
        const ts = G.tabs[sid];
        if (!ts || idx < 0 || idx >= ts.images.length) return;
        G.previewTabId = sid;
        G.previewIndex = idx;
        const fn = ts.images[idx];
        document.getElementById('previewImage').src = `/api/session/${sid}/image/${encodeURIComponent(fn)}`;
        document.getElementById('previewCounter').textContent = `${idx + 1} / ${ts.images.length}`;
        document.getElementById('previewModal').classList.remove('hidden');
        document.getElementById('previewModal').classList.add('flex');
        document.body.style.overflow = 'hidden';
    }

    function hidePreview() {
        document.getElementById('previewModal').classList.add('hidden');
        document.getElementById('previewModal').classList.remove('flex');
        document.body.style.overflow = '';
        G.previewTabId = null;
        G.previewIndex = -1;
    }

    function prevPreview() {
        if (G.previewIndex > 0) showPreview(G.previewTabId, G.previewIndex - 1);
    }

    function nextPreview() {
        const ts = G.tabs[G.previewTabId];
        if (ts && G.previewIndex < ts.images.length - 1) showPreview(G.previewTabId, G.previewIndex + 1);
    }

    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', (e) => {
        if (document.getElementById('recycleDrawer').classList.contains('open')) {
            if (e.key === 'Escape') { closeRecycleBin(); return; }
        }
        if (!document.getElementById('previewModal').classList.contains('hidden')) {
            if (e.key === 'Escape') hidePreview();
            if (e.key === 'ArrowLeft') prevPreview();
            if (e.key === 'ArrowRight') nextPreview();
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const sid = G.previewTabId;
                const idx = G.previewIndex;
                if (sid && idx >= 0) { hidePreview(); deleteImage(sid, idx); }
            }
            return;
        }
        // Ctrl+Z å…¨å±€æ’¤é”€
        if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            if (G.activeTabId) undoLastDelete(G.activeTabId);
        }
    });

    // ============================================================
    //  æ‰“åŒ…å¯¼å‡º
    // ============================================================
    async function packageImages(sid, fmt) {
        const ts = G.tabs[sid];
        if (!ts || ts.images.length === 0) { showToast('ç”»å»Šä¸­æ²¡æœ‰å›¾ç‰‡', 'warning'); return; }

        const btnMap = { pdf: q(sid, 'js-btn-pdf'), pptx: q(sid, 'js-btn-pptx'), zip: q(sid, 'js-btn-zip') };
        const btn = btnMap[fmt];
        const origHTML = btn ? btn.innerHTML : '';
        if (btn) { btn.style.pointerEvents = 'none'; btn.style.opacity = '0.5'; btn.querySelector('.text-base').textContent = 'â³ æ‰“åŒ…ä¸­â€¦'; }

        const data = await api(`/api/session/${sid}/package`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ format: fmt, files: ts.images }),
        });

        if (btn) { btn.style.pointerEvents = ''; btn.style.opacity = ''; btn.innerHTML = origHTML; }

        if (data.success) {
            showToast(`${fmt.toUpperCase()} æ‰“åŒ…å®Œæˆï¼`, 'success');
            addDownloadLink(sid, data.filename, fmt);
        } else {
            showToast(data.message, 'error');
        }
    }

    function addDownloadLink(sid, filename, fmt) {
        const ts = G.tabs[sid];
        if (!ts) return;
        const sec = q(sid, 'js-download-section');
        sec.classList.remove('hidden');

        if (ts.downloadLinks.includes(filename)) return;
        ts.downloadLinks.push(filename);

        const icons = { pdf:'ğŸ“„', pptx:'ğŸ“Š', zip:'ğŸ“¦' };
        const el = document.createElement('a');
        el.href = `/api/session/${sid}/download/${encodeURIComponent(filename)}`;
        el.className = 'flex items-center gap-3 px-4 py-3 bg-emerald-50 border border-emerald-200 rounded-xl hover:bg-emerald-100 transition text-emerald-800 text-sm font-medium';
        el.innerHTML = `<span class="text-xl">${icons[fmt]||'ğŸ“'}</span> ${filename} <span class="ml-auto text-xs text-emerald-500">ç‚¹å‡»ä¸‹è½½ â†“</span>`;
        el.download = filename;
        sec.appendChild(el);
    }

    // ============================================================
    //  å…¨å±€æ¸…ç†
    // ============================================================
    async function cleanupAll() {
        const tabCount = Object.keys(G.tabs).length;
        if (tabCount === 0) { showToast('æ²¡æœ‰éœ€è¦æ¸…ç†çš„æ ‡ç­¾é¡µ', 'info'); return; }
        if (!confirm(`ç¡®å®šè¦å…³é—­æ‰€æœ‰ ${tabCount} ä¸ªæ ‡ç­¾é¡µå¹¶æ¸…ç©ºå…¨éƒ¨ç¼“å­˜å—ï¼Ÿ`)) return;

        // åœæ­¢æ‰€æœ‰è½®è¯¢
        for (const sid of Object.keys(G.tabs)) {
            const ts = G.tabs[sid];
            if (ts.pollTimer) clearTimeout(ts.pollTimer);
        }
        await api('/api/cleanup-all', { method: 'POST' });

        // æ¸…é™¤ UI
        document.querySelectorAll('.tab-item').forEach(t => t.remove());
        document.querySelectorAll('.tab-pane').forEach(p => p.remove());
        G.tabs = {};
        G.activeTabId = null;
        const hint = document.getElementById('emptyHint');
        if (hint) hint.style.display = '';
        updateTabAddBtn();
        closeRecycleBin();
        showToast('å…¨éƒ¨æ¸…ç©ºå®Œæˆ', 'success');
    }

    // ============================================================
    //  ç³»ç»Ÿèµ„æºç›‘æ§
    // ============================================================
    async function refreshResourceBar() {
        try {
            const data = await api('/api/system/status');
            if (!data.cpu_percent && data.cpu_percent !== 0) return;

            // CPU
            document.getElementById('resCpuText').textContent = data.cpu_percent.toFixed(0) + '%';
            document.getElementById('resCpuBar').style.width = data.cpu_percent + '%';
            document.getElementById('resCpuBar').style.background = data.cpu_percent > 90 ? '#ef4444' : data.cpu_percent > 70 ? '#f59e0b' : '#60a5fa';
            document.getElementById('resCpuText').classList.toggle('res-warn', data.cpu_percent > 90);

            // å†…å­˜
            document.getElementById('resMemText').textContent = data.memory_percent.toFixed(0) + '% (' + data.memory_used_gb + '/' + data.memory_total_gb + ' GB)';
            document.getElementById('resMemBar').style.width = data.memory_percent + '%';
            document.getElementById('resMemBar').style.background = data.memory_percent > 85 ? '#ef4444' : data.memory_percent > 70 ? '#f59e0b' : '#34d399';
            document.getElementById('resMemText').classList.toggle('res-warn', data.memory_percent > 85);

            // ç£ç›˜
            document.getElementById('resDiskText').textContent = data.disk_free_gb + ' GB';
            document.getElementById('resDiskText').classList.toggle('res-warn', data.disk_free_gb < 0.5);

            // ä»»åŠ¡æ•°
            document.getElementById('resTaskText').textContent = data.active_tasks;
            document.getElementById('resTabText').textContent = data.total_sessions + '/' + data.max_sessions;

            G.maxSessions = data.max_sessions;

            // å‘Šè­¦æ¨ªå¹…
            const banner = document.getElementById('resourceWarning');
            if (data.warning) {
                banner.textContent = 'âš ï¸ ç³»ç»Ÿèµ„æºå‘Šè­¦ï¼š' + data.warning;
                banner.classList.add('visible');
            } else {
                banner.classList.remove('visible');
            }
        } catch (e) {
            console.warn('[Resource] è·å–èµ„æºçŠ¶æ€å¤±è´¥:', e);
        }
    }

    // æ¯ 3 ç§’åˆ·æ–°ä¸€æ¬¡èµ„æºçŠ¶æ€
    setInterval(refreshResourceBar, 3000);
    refreshResourceBar();

    // ============================================================
    //  å¿ƒè·³ & æ–­è¿æ£€æµ‹
    // ============================================================
    let _serverAlive = true;
    let _heartbeatFailCount = 0;
    const HEARTBEAT_FAIL_THRESHOLD = 2;

    function showDisconnectOverlay() {
        if (document.getElementById('disconnectOverlay')) return;
        _serverAlive = false;
        const overlay = document.createElement('div');
        overlay.id = 'disconnectOverlay';
        overlay.style.cssText = 'position:fixed;inset:0;z-index:99999;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,0.85);backdrop-filter:blur(4px);';
        overlay.innerHTML = `
            <div style="text-align:center;max-width:480px;padding:48px 36px;background:white;border-radius:16px;box-shadow:0 25px 50px rgba(0,0,0,0.25);">
                <div style="font-size:56px;margin-bottom:16px;">âš ï¸</div>
                <h1 style="font-size:22px;font-weight:700;color:#1e293b;margin-bottom:12px;">åç«¯æœåŠ¡å·²æ–­å¼€</h1>
                <p style="color:#475569;line-height:1.7;font-size:15px;margin-bottom:20px;">
                    æœåŠ¡è¿›ç¨‹å·²æ„å¤–é€€å‡ºæˆ–è¢«å…³é—­ã€‚<br>å½“å‰é¡µé¢çš„æ•°æ®å¯èƒ½æ— æ³•ä¿å­˜ã€‚
                </p>
                <div style="background:#f1f5f9;border-radius:10px;padding:16px 20px;text-align:left;margin-bottom:20px;">
                    <p style="color:#334155;font-size:14px;font-weight:600;margin-bottom:8px;">ğŸ”§ å¦‚ä½•æ¢å¤ï¼š</p>
                    <ol style="color:#475569;font-size:14px;line-height:1.8;padding-left:20px;margin:0;">
                        <li>å…³é—­å½“å‰æµè§ˆå™¨é¡µé¢</li>
                        <li>é‡æ–°åŒå‡» <b>VidSlide.exe</b> å¯åŠ¨</li>
                    </ol>
                </div>
                <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                    <button onclick="location.reload()" style="padding:10px 20px;background:#e2e8f0;color:#334155;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;">ğŸ”„ åˆ·æ–°é‡è¯•</button>
                    <a href="https://github.com/PWO-CHINA/VidSlide/issues/new?title=${encodeURIComponent('[Bug] åç«¯æœåŠ¡æ„å¤–æ–­å¼€')}&body=${encodeURIComponent('## é—®é¢˜æè¿°\\nåç«¯æœåŠ¡æ„å¤–æ–­å¼€è¿æ¥ã€‚\\n\\n## ç¯å¢ƒä¿¡æ¯\\n- æ—¶é—´: ' + new Date().toLocaleString() + '\\n\\n## å¤ç°æ­¥éª¤\\n1. \\n2. \\n3. ')}" target="_blank" style="padding:10px 20px;background:#6366f1;color:white;border:none;border-radius:8px;font-size:14px;font-weight:500;cursor:pointer;text-decoration:none;">ğŸ› æäº¤ Issue</a>
                </div>
            </div>`;
        document.body.appendChild(overlay);
    }

    async function sendHeartbeat() {
        try {
            const resp = await fetch('/api/heartbeat', { method: 'POST', signal: AbortSignal.timeout(5000) });
            if (resp.ok) { _heartbeatFailCount = 0; _serverAlive = true; } else { _heartbeatFailCount++; }
        } catch { _heartbeatFailCount++; }
        if (_heartbeatFailCount >= HEARTBEAT_FAIL_THRESHOLD) showDisconnectOverlay();
    }
    setInterval(sendHeartbeat, 8000);
    sendHeartbeat();

    // ============================================================
    //  å…³é—­æœåŠ¡
    // ============================================================
    async function shutdownServer() {
        const hasWork = Object.values(G.tabs).some(ts => ts.images.length > 0 && ts.downloadLinks.length === 0);
        let msg = 'ç¡®å®šè¦å…³é—­å·¥å…·å—ï¼Ÿ\n\nå…³é—­åï¼š\nâ€¢ æœåŠ¡å°†åœæ­¢è¿è¡Œ\nâ€¢ æ‰€æœ‰æ ‡ç­¾é¡µçš„ä¸´æ—¶ç¼“å­˜ä¼šè‡ªåŠ¨æ¸…ç†';
        if (hasWork) msg += '\nâ€¢ âš ï¸ æœ‰æœªå¯¼å‡ºçš„å›¾ç‰‡å°†ä¸¢å¤±';
        if (!confirm(msg)) return;
        showToast('æ­£åœ¨å…³é—­æœåŠ¡â€¦', 'info');
        try { await fetch('/api/shutdown', { method: 'POST' }); } catch {}
        setTimeout(() => {
            document.body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#f8fafc;">
                    <div style="text-align:center;max-width:400px;padding:40px;">
                        <div style="font-size:64px;margin-bottom:20px;">ğŸ‘‹</div>
                        <h1 style="font-size:24px;font-weight:bold;color:#1e293b;margin-bottom:12px;">å·¥å…·å·²å…³é—­</h1>
                        <p style="color:#64748b;line-height:1.6;">æœåŠ¡å·²å®‰å…¨é€€å‡ºï¼Œä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†ã€‚<br>å¯ä»¥å…³é—­æ­¤é¡µé¢äº†ã€‚</p>
                    </div>
                </div>`;
        }, 600);
    }

    // ============================================================
    //  é¡µé¢ç¦»å¼€ä¿æŠ¤
    // ============================================================
    window.addEventListener('beforeunload', (e) => {
        const hasWork = Object.values(G.tabs).some(ts => ts.hasWork && ts.images.length > 0);
        if (hasWork) {
            e.preventDefault();
            e.returnValue = 'æœ‰æœªå¯¼å‡ºçš„å›¾ç‰‡ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
            return e.returnValue;
        }
    });

    window.addEventListener('pagehide', () => {
        navigator.sendBeacon('/api/heartbeat', '');
    });

    // ============================================================
    //  åˆå§‹åŒ–ï¼šè‡ªåŠ¨åˆ›å»ºç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
    // ============================================================
    (async function init() {
        // å…ˆè·å–å·²æœ‰ä¼šè¯ä¿¡æ¯ï¼ˆå¦‚åˆ·æ–°é¡µé¢åæ¢å¤ï¼‰
        const sessData = await api('/api/sessions');
        if (sessData.success) {
            G.maxSessions = sessData.max_sessions || 3;
        }
        // è‡ªåŠ¨åˆ›å»ºç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ
        await addNewTab();
    })();
    </script>
</body>
</html>