<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>影幻智提 (VidSlide) v0.3.2 - 性能狂飙版</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50:'#eef2ff',100:'#e0e7ff',200:'#c7d2fe',300:'#a5b4fc',400:'#818cf8',500:'#6366f1',600:'#4f46e5',700:'#4338ca',800:'#3730a3',900:'#312e81' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50/30 to-indigo-50/40 min-h-screen pb-8">

    <!-- Toast 容器 -->
    <div id="toasts" class="fixed top-5 right-5 z-[100] flex flex-col gap-3 pointer-events-none" style="max-width:360px"></div>

    <!-- 错误详情弹窗 -->
    <div id="errorModal" class="error-modal-backdrop" onclick="if(event.target===this)closeErrorModal()">
        <div class="error-modal">
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3"><span class="text-3xl">❌</span><h2 class="text-lg font-bold text-gray-900" id="errorModalTitle">出错了</h2></div>
                <button onclick="closeErrorModal()" class="text-gray-400 hover:text-gray-700 text-xl leading-none">&times;</button>
            </div>
            <div id="errorModalMessage" class="text-sm text-gray-700 mb-3 leading-relaxed"></div>
            <div id="errorModalHint" class="bg-amber-50 border border-amber-200 rounded-xl p-3 text-sm text-amber-800 mb-4 hidden">
                <p class="font-semibold mb-1">💡 建议操作：</p>
                <p id="errorModalHintText"></p>
            </div>
            <div class="flex items-center gap-3 flex-wrap">
                <button onclick="closeErrorModal()" class="btn-secondary" style="min-width:80px">关闭</button>
                <a id="errorModalIssueLink" href="#" target="_blank" class="btn-primary flex items-center gap-2" style="text-decoration:none;font-size:13px">
                    🐛 提交 Issue 反馈
                </a>
            </div>
        </div>
    </div>

    <!-- ═══════ Header ═══════ -->
    <header class="bg-gradient-to-r from-brand-700 via-brand-600 to-blue-500 text-white shadow-xl">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold tracking-tight flex items-center gap-2">
                    <span class="text-3xl">📊</span> 影幻智提 (VidSlide)
                    <span class="text-xs font-normal bg-white/15 px-2 py-0.5 rounded-full ml-2">v0.3.2 性能狂飙</span>
                </h1>
                <p class="text-brand-200 text-sm mt-1">从录播视频中一键提取 PPT · SSE 推送 · GPU 加速 · 异步打包</p>
            </div>
            <div class="flex gap-2">
                <button onclick="cleanupAll()" class="btn-ghost" title="清空所有标签页缓存">
                    🗑️ 全部清空
                </button>
                <button onclick="shutdownServer()" class="btn-ghost-danger" title="关闭服务并清理临时文件">
                    ⏻ 关闭工具
                </button>
            </div>
        </div>
    </header>

    <!-- ═══════ 资源监控条 ═══════ -->
    <div class="resource-bar" id="resourceBar">
        <div class="resource-item">
            <span class="res-label">CPU</span>
            <div class="res-bar-mini"><div id="resCpuBar" class="res-bar-mini-fill bg-blue-400" style="width:0%"></div></div>
            <span class="res-value" id="resCpuText">--%</span>
        </div>
        <div class="resource-item">
            <span class="res-label">内存</span>
            <div class="res-bar-mini"><div id="resMemBar" class="res-bar-mini-fill bg-emerald-400" style="width:0%"></div></div>
            <span class="res-value" id="resMemText">--%</span>
        </div>
        <div class="resource-item">
            <span class="res-label">磁盘剩余</span>
            <span class="res-value" id="resDiskText">-- GB</span>
        </div>
        <div class="resource-item" id="resGpuSection" style="display:none">
            <span class="res-label">GPU</span>
            <div class="res-bar-mini"><div id="resGpuBar" class="res-bar-mini-fill bg-purple-400" style="width:0%"></div></div>
            <span class="res-value" id="resGpuText">--%</span>
        </div>
        <div class="resource-item" style="border-left:1px solid #d1d5db;padding-left:12px">
            <span class="res-label">活跃任务</span>
            <span class="res-value" id="resTaskText">0</span>
        </div>
        <div class="resource-item">
            <span class="res-label">标签页</span>
            <span class="res-value" id="resTabText">0/3</span>
        </div>
    </div>
    <div class="resource-warning-banner" id="resourceWarning"></div>

    <!-- ═══════ 主区域 ═══════ -->
    <main class="max-w-7xl mx-auto px-6 py-6">

        <!-- 标签栏 -->
        <div class="tab-bar" id="tabBar">
            <!-- 标签会动态插入 -->
            <div class="tab-add" id="tabAddBtn" onclick="addNewTab()" title="新建标签页 (最多3个)">＋</div>
        </div>

        <!-- 标签页内容区 -->
        <div class="tab-content-area" id="tabContentArea">
            <!-- 每个标签页的内容面板会动态插入 -->
            <div id="emptyHint" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <span class="text-5xl mb-4">📂</span>
                <p class="text-lg font-medium mb-2">点击上方 ＋ 新建一个标签页开始工作</p>
                <p class="text-sm">每个标签页可独立处理一个视频，最多同时开 3 个</p>
            </div>
        </div>
    </main>

    <!-- ═══════ 底部 ═══════ -->
    <footer class="max-w-5xl mx-auto px-4 pb-8 text-center">
        <p class="text-xs text-gray-300">🔒 所有数据仅保存在本地。浏览器断联 5 分钟后服务自动退出（有任务时延长等待）。</p>
        <p class="text-xs text-gray-300 mt-1">影幻智提 (VidSlide) v0.3.2 性能狂飙版 · Made by PWO-CHINA</p>
    </footer>

    <!-- ═══════ 回收站抽屉 ═══════ -->
    <div id="recycleBackdrop" class="recycle-backdrop" onclick="closeRecycleBin()"></div>
    <div id="recycleDrawer" class="recycle-drawer">
        <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                🗑️ 回收站 <span id="recycleDrawerCount" class="text-sm font-normal text-gray-400"></span>
            </h3>
            <div class="flex gap-2">
                <button onclick="restoreAll()" id="btnRestoreAll" class="btn-secondary" style="font-size:.75rem;padding:.375rem .75rem;color:#4f46e5;border-color:#c7d2fe;background:#eef2ff">
                    ↩️ 全部恢复
                </button>
                <button onclick="closeRecycleBin()" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-gray-400 hover:text-gray-600 flex items-center justify-center transition">✕</button>
            </div>
        </div>
        <div id="recycleList" class="flex-1 overflow-y-auto p-4 space-y-2">
            <p id="recycleEmpty" class="text-center text-gray-400 text-sm py-12">回收站是空的</p>
        </div>
    </div>

    <!-- ═══════ 图片预览弹窗 ═══════ -->
    <div id="previewModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop" onclick="if(event.target===this)hidePreview()">
        <button onclick="hidePreview()" class="absolute top-5 right-5 w-10 h-10 rounded-full bg-white/10 hover:bg-white/25 text-white text-xl flex items-center justify-center transition">✕</button>
        <button onclick="deleteInPreview()" id="btnDeletePreview" class="absolute bottom-6 right-5 z-[60] px-4 py-2 rounded-full bg-red-500/70 hover:bg-red-600/90 text-white text-sm font-medium flex items-center gap-1.5 transition shadow-lg backdrop-blur" title="删除当前图片 (Delete)">🗑️ 删除 (Del)</button>
        <button onclick="prevPreview()" id="btnPrevPreview" class="absolute left-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/25 text-white text-2xl flex items-center justify-center transition">◀</button>
        <button onclick="nextPreview()" id="btnNextPreview" class="absolute right-4 top-1/2 -translate-y-1/2 w-12 h-12 rounded-full bg-white/10 hover:bg-white/25 text-white text-2xl flex items-center justify-center transition">▶</button>
        <img id="previewImage" class="max-w-[90vw] max-h-[85vh] rounded-lg shadow-2xl object-contain select-none" draggable="false">
        <div id="previewCounter" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-black/60 text-white text-sm px-4 py-1.5 rounded-full backdrop-blur"></div>
    </div>

    <!-- ═══════ 标签页内容模板（hidden，JS 克隆使用）═══════ -->
    <template id="tabPaneTemplate">
        <div class="tab-pane p-6 space-y-6">
            <!-- 步骤 1: 选择视频 -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">1</span>
                    选择视频文件
                </h2>
                <div class="flex flex-col sm:flex-row gap-3 items-stretch">
                    <button class="btn-primary shrink-0 js-btn-select-video">📁 浏览选择视频文件</button>
                    <div class="relative flex-1">
                        <input type="text" class="js-video-path-input w-full h-full px-4 py-3 text-sm rounded-2xl border-2 border-gray-200 focus:border-brand-400 focus:ring-4 focus:ring-brand-100 outline-none transition bg-gray-50 placeholder-gray-400" placeholder='粘贴路径，支持引号包裹，如 "D:\video\lecture.mp4"'>
                        <button class="js-btn-confirm-path absolute right-2 top-1/2 -translate-y-1/2 text-xs text-white bg-brand-500 hover:bg-brand-600 font-medium px-3 py-1.5 rounded-lg transition shadow-sm">确认 ↵</button>
                    </div>
                </div>
                <div class="js-video-info hidden mt-3 px-4 py-3 bg-emerald-50 border border-emerald-200 rounded-xl">
                    <p class="text-sm text-emerald-800 flex items-center gap-2">
                        <span class="text-lg">✅</span>
                        <span class="js-video-path-display font-mono text-xs break-all"></span>
                    </p>
                </div>
            </section>

            <!-- 步骤 2: 参数设置 -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">2</span>
                    提取参数
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-sm font-medium text-gray-700">场景检测灵敏度</label>
                        <input type="range" min="1" max="15" step="0.5" value="5" class="range-input js-threshold">
                        <div class="flex justify-between text-xs text-gray-400">
                            <span>敏感 (1)</span>
                            <span class="text-sm font-bold text-brand-600 js-threshold-val">5</span>
                            <span>保守 (15)</span>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-use-roi">
                            PPT 录屏裁剪
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed">启用后忽略左侧缩略图栏和顶部工具栏</p>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-enable-history">
                            历史记忆池
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed">防止 A→B→A 跳页导致重复提取</p>
                        <div class="js-max-history-group items-center gap-2 text-sm text-gray-600" style="display:none">
                            <span>容量:</span>
                            <input type="number" value="5" min="2" max="20" class="w-16 px-2 py-1 text-sm rounded-lg border border-gray-200 text-center js-max-history">
                            <span class="text-xs text-gray-400">张</span>
                        </div>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100">
                    <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                        <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-fast-mode">
                        ⚡ 快速模式
                    </label>
                    <p class="text-xs text-gray-400 leading-relaxed mt-1">将比较分辨率降至 480p 以加速检测（不影响输出图片质量）</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-100 flex flex-col sm:flex-row sm:items-start gap-6">
                    <div class="flex-1">
                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-brand-600 rounded border-gray-300 focus:ring-brand-400 js-use-gpu">
                            🎮 GPU 硬件加速
                        </label>
                        <p class="text-xs text-gray-400 leading-relaxed mt-1">使用显卡加速视频解码（不支持时自动回退 CPU）。如遇花屏/崩溃可关闭此选项</p>
                    </div>
                    <div class="flex-1">
                        <label class="text-sm font-medium text-gray-700 block mb-1">🎯 运行模式</label>
                        <select class="js-speed-mode w-full px-3 py-2 text-sm rounded-xl border-2 border-gray-200 focus:border-brand-400 focus:ring-4 focus:ring-brand-100 outline-none transition bg-white">
                            <option value="eco">🍃 后台静默 (Eco)</option>
                            <option value="fast">🚀 全速狂飙 (Fast)</option>
                            <option value="turbo">⚡ 极速狂暴 (Turbo)</option>
                        </select>
                        <p class="text-xs text-gray-400 leading-relaxed mt-1">Eco 节省资源；Fast 释放算力；Turbo 极限压榜（2x跳帧+320p对比）</p>
                    </div>
                </div>
                <div class="mt-3 px-3 py-2.5 bg-amber-50 border border-amber-200 rounded-xl">
                    <p class="text-xs text-amber-700 leading-relaxed">💡 <strong>核显用户极速组合</strong>：选择 <em>Turbo/Fast</em> + <em>关闭 GPU 加速</em>，让 CPU 负责解码速度更快。核显的 GPU 加速主要优势是“减负”而非“加速”，适合 Eco 模式后台挂机。</p>
                </div>
            </section>

            <!-- 步骤 3: 提取 -->
            <section class="card">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">3</span>
                    提取幻灯片
                </h2>
                <div class="flex items-center gap-3">
                    <button class="btn-primary js-btn-extract" disabled>▶️ 开始提取幻灯片</button>
                    <button class="btn-danger hidden js-btn-cancel">⏹️ 取消提取</button>
                    <span class="text-sm text-gray-500 js-extract-status"></span>
                </div>
                <div class="js-progress-section hidden mt-5 space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 font-medium js-progress-message">正在初始化…</span>
                        <span class="font-bold text-brand-600 text-lg tabular-nums js-progress-pct">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill js-progress-bar" style="width:0%"></div>
                    </div>
                    <p class="text-xs text-gray-400 js-progress-hint">提取中，请勿关闭此页面…</p>
                </div>
            </section>

            <!-- 步骤 4: 画廊管理 -->
            <section class="card hidden js-gallery-section">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-4">
                    <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">4</span>
                        图片管理
                        <span class="text-sm font-normal text-gray-400 ml-2 js-image-count"></span>
                    </h2>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button class="btn-secondary text-sm hidden js-btn-recycle-bin">
                            🗑️ 回收站 <span class="bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 ml-1 js-recycle-count"></span>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-4 flex items-center gap-4">
                    <span>🖱️ 拖拽调整顺序</span>
                    <span>🔍 点击预览大图</span>
                    <span>❌ 悬停显示删除</span>
                    <span>⌨️ Ctrl+Z 撤销删除</span>
                </p>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 js-gallery"></div>
            </section>

            <!-- 步骤 5: 打包导出 -->
            <section class="card hidden js-export-section">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2 mb-4">
                    <span class="w-7 h-7 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-sm font-bold">5</span>
                    打包导出
                </h2>
                <p class="text-sm text-gray-500 mb-5">将当前排好序的图片打包下载</p>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <button class="btn-export js-btn-pdf">
                        <span class="text-3xl">📄</span>
                        <span class="text-base font-bold">生成 PDF</span>
                        <span class="text-xs text-gray-400 font-normal">适合打印和阅读</span>
                    </button>
                    <button class="btn-export js-btn-pptx">
                        <span class="text-3xl">📊</span>
                        <span class="text-base font-bold">生成 PPTX</span>
                        <span class="text-xs text-gray-400 font-normal">可编辑的演示文稿</span>
                    </button>
                    <button class="btn-export js-btn-zip">
                        <span class="text-3xl">📦</span>
                        <span class="text-base font-bold">打包 ZIP</span>
                        <span class="text-xs text-gray-400 font-normal">原图打包压缩</span>
                    </button>
                </div>
                <p class="text-xs text-gray-400 mt-3">💡 导出的文件会保存到浏览器的默认<b>下载文件夹</b>中</p>

                <!-- 打包进度条（SSE 驱动，异步打包时显示） -->
                <div class="hidden mt-5 space-y-2 js-pkg-progress-section">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600 font-medium flex items-center gap-2">
                            <span class="pkg-spinner"></span>
                            <span class="js-pkg-progress-message">正在打包…</span>
                        </span>
                        <span class="font-bold text-brand-600 text-sm tabular-nums js-pkg-progress-pct">0%</span>
                    </div>
                    <div class="progress-track" style="height:10px">
                        <div class="progress-fill js-pkg-progress-bar" style="width:0%;height:100%"></div>
                    </div>
                </div>

                <div class="hidden mt-5 space-y-2 js-download-section"></div>
            </section>
        </div>
    </template>

    <script src="/static/js/main.js"></script>
</body>
</html>
